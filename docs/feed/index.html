<?xml version="1.0" encoding="utf-8" ?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[Martin Hujer blog]]></title>
    <link href="https://blog.martinhujer.cz/feed/" rel="self"/>
    <link href="https://blog.martinhujer.cz/"/>
    <updated>2018-11-16T10:27:34+00:00</updated>
    <id>https://blog.martinhujer.cz/</id>
            <author>
            <name><![CDATA[Martin Hujer]]></name>                    </author>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[Use different Google Analytics ID by domain in Google Tag Manager]]></title>
            <link href="https://blog.martinhujer.cz/use-different-google-analytics-id-by-domain-in-tag-manager/"/>
            <updated>2018-08-26T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/use-different-google-analytics-id-by-domain-in-tag-manager/</id>
            <content type="html"><![CDATA[<p>When setting up Google Analytics (or Facebook Pixel) in the Google Tag Manager the typical approach is to put the UA-code or the Pixel ID into the <em>Constant</em> Variable. And that ID is then used in the GA/Facebook <em>Tag</em>.</p>

<p>But soon after launch the people from Marketing will start complaining that some strange orders and conversions are appearing in the Google Analytics.</p>

<p>What happened? Apart from real orders, also the orders made in testing and dev environments are sent there.</p>

<p>There is a better way. 
<strong>You can easily use different UA codes in production and in testing environments.</strong>
In the rest of the article I will guide you through setting it up.</p>

<h2 id="analysis">Analysis</h2>

<p>It is clear that we want to use testing UA code in dev/test environments, but apart from that we also want to use it when testing the Google Tag Manager configuration itself with <em>Preview feature</em> (even on production website).</p>

<p>The decision process for the UA code goes like this:</p>

<ul>
<li><strong>Are we running in Debug mode?</strong>

<ul>
<li><strong>YES</strong>: use test ID</li>
<li><strong>NO</strong>:</li>
<li><strong>Are we on production domain?</strong>

<ul>
<li><strong>YES</strong>: use real ID</li>
<li><strong>NO</strong>: use test ID</li>
</ul></li>
</ul></li>
</ul>

<h2 id="preparation">Preparation</h2>

<ol>
<li><p>Go to Google Tag Manager and create two <em>Constant</em> Variables:</p>

<ul>
<li><code>GA_ID_DEV</code> with the testing ID</li>
<li><code>GA_ID_PROD</code> with the production ID</li>
</ul></li>
<li><p>In the Variables section in <em>Built-In Variables</em> enable <code>Debug Mode</code> and <code>Page Hostname</code> variables.</p></li>
</ol>

<h2 id="setting-up-the-hostname-detection">Setting up the hostname detection</h2>

<ol>
<li>Create a Variable of type <code>Lookup Table</code> and name it <code>GA_ID_BY_HOSTNAME</code></li>
<li><em>Input Variable</em> is <code>{{Page Hostname}}</code></li>
<li>Click <em>Add row</em></li>
<li>Put your production domain into the <em>Input</em> field (just the domain without <code>https://</code> and the trailing <code>/</code>)</li>
<li>Put <code>{{GA_ID_PROD}}</code> into the <em>Output</em> field</li>
<li>Check <em>Set default value</em> checkbox</li>
<li>Put <code>{{GA_ID_DEV}}</code> to the <em>Default value</em> field</li>
</ol>

<p>It should look like this:
<img src="/data/2018/2018-08-26-use-different-code-id/01-by-hostname.png" alt="GA_ID_BY_HOSTNAME variable configuration" /></p>

<p>By defining only the production domain and using <em>default value</em> for anything else, we handle any testing or dev environment.</p>

<h2 id="setting-up-the-debug-environment-detection">Setting up the Debug environment detection</h2>

<p>If you look back into the <em>Analysis</em> chapter, we have covered the <em>Are we on production domain?</em> part. Now we will cover the <em>Are we running in Debug mode?</em>.</p>

<ol>
<li>Create a Variable of type <code>Lookup Table</code> and name it <code>GA_ID</code></li>
<li><em>Input Variable</em> is <code>{{Debug Mode}}</code></li>
<li>Click <em>Add row</em></li>
<li>Put <code>true</code> into the <em>Input</em> field and <code>{{GA_ID_DEV}}</code> into the <em>Output</em> field</li>
<li>Click <em>Add row</em> again</li>
<li>Put <code>false</code> into the <em>Input</em> field and <code>{{GA_ID_BY_HOSTNAME}}</code> into the <em>Output</em> field</li>
</ol>

<p>It should look like this:
<img src="/data/2018/2018-08-26-use-different-code-id/02-by-debugmode.png" alt="GA_ID variable configuration" /></p>

<p>You might have noticed that we have used the variable <code>GA_ID_BY_HOSTNAME</code> which we prepared in previous step.</p>

<h2 id="setting-up-the-google-analytics-tag">Setting up the Google Analytics Tag</h2>

<p>With all those variables prepared, you can set up the Google Analytics tag as usual. But when creating the <code>Google Analytics Settings</code>, put <code>{{GA_ID}}</code> into the <em>Tracking ID</em> field as in the following picture. It will be resolved to correct UA code depending on the environment.</p>

<p><img src="/data/2018/2018-08-26-use-different-code-id/03-tag-settings.png" alt="Google Analytics Settings variable" /></p>

<p>That's it!</p>

<h2 id="conclusion">Conclusion</h2>

<p>Apart from Google Analytics ID, you can use this guide to set up Facebook Pixel ID or any other system where you can easily create different IDs for different environments.</p>

<p>Are you using similar approach? Or did you find a better way? Let me know in the comments!</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Consistence brings consistency to the PHP]]></title>
            <link href="https://blog.martinhujer.cz/consistence-brings-consistency-to-the-php/"/>
            <updated>2018-02-06T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/consistence-brings-consistency-to-the-php/</id>
            <content type="html"><![CDATA[<p><strong>In the article I describe the <a href="https://github.com/consistence/consistence/">Consistence library</a> that aims to bring consistency to PHP applications.</strong></p>

<p>There is no argument, that PHP can sometimes be <em>a bit</em> inconsistent about naming stuff and maintaining order of parameters for related functions. Also, in some cases it is not strict and allows you to use the language and the functions in a wrong way. Sometimes you get <code>false</code> as a return value where an exception would be appropriate.</p>

<p>I really like the idea of code being strict because it prevents errors in the application. E.g. <code>strpos</code> usually returns <code>int</code>, but it returns <code>false</code> when the <code>$needle</code> was not found. It would be much better to throw <code>SubstringNotFoundException</code> in that case.</p>

<p>Consistence provides opinionated strict wrappers with better error handling and consistent naming and consistent parameters order.</p>

<blockquote>
  <p><em><strong>Disclaimer:</strong> I haven't created the library, but I find it useful and I hope you will as well. It is one of the packages I use on every project.</em></p>
</blockquote>

<p>Let's dive into it.</p>

<h2 id="use-enums-for-better-type-safety">Use Enums for better type safety</h2>

<p>It's a good practice to use constants instead of passing magic numbers (or magic strings) around. But you still pass them as a string, so there is nothing that prevents you from passing any other arbitrary string:</p>

<pre><code class="php">&lt;?php
class BodyType
{
    const SUV = 'suv';
    const COMBI = 'combi';
    const HATCHBACK = 'hatchback';
    const CABRIO = 'cabrio';
    // ... 
}

function createCar(string $bodyType) {
    // do something with $bodyType
}

$car = createCar(BodyType::CABRIO);
$car = createCar('doubledecker'); // unexpected things can happen
</code></pre>

<p>Consistence provides an <a href="https://github.com/consistence/consistence/blob/master/docs/Enum/enums.md">enum implementation</a>. When you extend the class from <code>Enum</code>, all constants are automatically treated as possible enum values:</p>

<pre><code class="php">&lt;?php
class BodyType extends \Consistence\Enum\Enum
{
    const SUV = 'suv';
    const COMBI = 'combi';
    const HATCHBACK = 'hatchback';
    const CABRIO = 'cabrio';
    // ...
}

function createCar(BodyType $bodyType) {
    echo $bodyType-&gt;getValue(); // you can use `getValue()` method to access the internal enum value
}

// use get() to get an instance of enum
$cabrioBodyType = BodyType::get(BodyType::CABRIO);

// It is a regular class instance
var_dump($cabrioBodyType instanceof BodyType); // bool(true)

// You always get the same instance, so you can compare them
var_dump(BodyType::get(BodyType::CABRIO) === BodyType::get(BodyType::CABRIO)); // bool(true)

// Type-hint checks work as expected
$car = createCar($cabrioBodyType); 

// Argument 1 passed to createCar() must be an instance of BodyType, string given
$car = createCar('doubledecker'); 
</code></pre>

<p>Enums also make it easier to write an actual code. Compare the following examples. When you want to instantiate the class from the first one, you have to dig into the documentation to check what are the allowed values:</p>

<pre><code class="php">&lt;?php
class Car
{
    public function __construct(
        string $bodyType,
        string $transmissionType,
        string $engineType,
        string $fuelType
    )
    {}
}
</code></pre>

<p>In the second one, you just start typing <code>BodyType::get(BodyType::</code> and then choose from the suggested values:</p>

<pre><code class="php">&lt;?php
class Car
{
    public function __construct(
        BodyType $bodyType,
        TransmissionType $transmissionType,
        EngineType $engineType,
        FuelType $fuelType
    )
    {}
}
</code></pre>

<p>There are <a href="https://github.com/consistence/consistence-doctrine">Doctrine</a> and <a href="https://github.com/consistence/consistence-doctrine-symfony/">Doctrine + Symfony</a> integrations which allow you to use Enums in Doctrine entities:</p>

<pre><code class="php">&lt;?php
use Consistence\Doctrine\Enum\EnumAnnotation as Enum;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity()
 */
class Car
{
    /**
     * @Enum(class=BodyType::class)
     * @ORM\Column(type="string_enum")
     * @var BodyType
     */
    private $bodyType;

    public function __construct(BodyType $bodyType)
    {
        $this-&gt;bodyType = $bodyType;
    }

    public function getBodyType(): BodyType
    {
        return $this-&gt;bodyType;
    }
}
</code></pre>

<p>If you need to represent multiple values, have a look at the <a href="https://github.com/consistence/consistence/blob/master/docs/Enum/multi-enums.md">MultiEnums</a>.</p>

<p><em>If the Consistence only provided the Enums, it would be enough reason for me to use it.</em></p>

<h2 id="use-%60objectprototype%60-to-disable-magic-methods">Use <code>ObjectPrototype</code> to disable magic methods</h2>

<p>In PHP you can write to undefined object properties. If the property is not defined and you assign a value to it, it is created in runtime.</p>

<p>I think it is a bad idea because it can hide subtle bugs and typos. Consider the following example, where I made a several mistakes in the code, but PHP almost did not complain.</p>

<pre><code class="php">&lt;?php
class MyClass
{
    public $foo;
}

$a = new MyClass();
$a-&gt;boo = 'bb'; // I made a typo, but PHP is fine with that

var_dump($a-&gt;foo);  // NULL
var_dump($a-&gt;boo);  // string(2) "bb"
var_dump($a-&gt;otherProperty);  // Notice:  Undefined property: MyClass::$otherProperty
</code></pre>

<p>If you want a more real-world example, consider this:</p>

<pre><code class="php">&lt;?php
$finalPrice = $product-&gt;price * $customer-&gt;distountRate;
</code></pre>

<p>There is a typo in a property name, so the <code>$finalPrice</code> would be <code>0</code>, because undefined property has <code>null</code> value which is converted to <code>0</code> and used in multiplication.</p>

<p>Consistence provides a straightforward way to mitigate this type of bugs. There is an <a href="https://github.com/consistence/consistence/blob/master/docs/Type/strict-types.md#strict-object"><code>ObjectPrototype</code></a> class which you can extend your classes from. If you try to assign or read something from an undefined property, an exception is thrown. Calling undefined methods throws an exception too. Those exceptions are not meant to be caught, but they should be fixed directly in your code.</p>

<pre><code class="php">&lt;?php
class MyClass extends \Consistence\ObjectPrototype
{
    public $foo;
}

$a = new MyClass();
$a-&gt;boo = 'bb'; // throws Consistence\UndefinedPropertyException

var_dump($a-&gt;foo); // NULL, but that does not matter, an exception would be thrown before
var_dump($a-&gt;boo); // throws Consistence\UndefinedPropertyException
var_dump($a-&gt;otherProperty); // throws Consistence\UndefinedPropertyException

$a-&gt;foo(); // throws Consistence\UndefinedMethodException
</code></pre>

<p>You're probably thinking, that using a base class for all classes is an awful code-smell!</p>

<p>I agree in general, but this case is different. If you consider the Consistence library to be an extension or augmentation of the standard PHP library, <code>ObjectPrototype</code> class is more like <code>Object</code> base class in Java. And nobody complains about it there.</p>

<p>The unseen advantage of this is that when you extend <code>ObjectPrototype</code>, you can't extend anything else, which is a good thing. You should be using composition as a code reuse mechanism anyway. In cases when the inheritance makes sense, you can use <code>ObjectMixinTrait</code> which enables the strict behaviour. Good example are the exceptions (they are objects too!):</p>

<pre><code class="php">&lt;?php
class MyCustomException extends \Exception
{
    use \Consistence\Type\ObjectMixinTrait;
}

$exception = new MyCustomException();
$exception-&gt;foo = 'a'; // throws Consistence\UndefinedPropertyException
</code></pre>

<p>Speaking of exceptions, there is a <a href="https://github.com/consistence/consistence/blob/master/src/exceptions/PhpException.php"><code>PhpException</code></a> which can be used as their base class. It has a shorter constructor without the mostly useless <code>$code</code> argument.</p>

<h2 id="strict-type-checking">Strict type checking</h2>

<p>PHP type-hints are powerful, but there are still a lot of things they can't check. You can put the detailed type info into the PHPDoc, but it is ignored at runtime. It only helps other developers and the IDE to better understand the code.</p>

<p>In the following example, IDE understands that the array contains <code>int</code> values, but PHP only checks that it is an <code>array</code>:</p>

<pre><code class="php">&lt;?php
/**
 * @param int[] $data
 */
function foo(array $data)
{
    var_dump($data);
}

foo([0, 1, 2]); // OK,
foo(['0', '1', '2']); // OK
foo(1); // not OK: Argument 1 passed to foo() must be of the type array, integer given
</code></pre>

<p>You can use <code>Type</code> class to manually check that the variable contains expected type:</p>

<pre><code class="php">&lt;?php
use Consistence\Type\Type;

/**
 * @param int[] $data
 */
function foo(array $data)
{
    Type::checkType($data, 'int[]');

    var_dump($data);
}

foo([0, 1, 2]); // OK 
foo(['0', '1', '2']); // throws Consistence\InvalidArgumentTypeException: int[] expected,  [array] given

</code></pre>

<p><code>Type::checkType()</code> throws an exception when the type-check fails. If you want to throw the exception yourself, you can use <code>Type::hasType($data, 'int[]')</code> which returns <code>boolean</code> value.</p>

<p>Here are some examples what else you can use as an expected type:</p>

<ul>
<li><code>object</code>: useful in &lt; PHP 7.2</li>
<li>Union types: <code>int|string</code> or <code>int[]|string[]</code></li>
<li>Collection of objects: <code>Product::class . '[]'</code></li>
<li>Array keys type: <code>int:string[]</code> (array of <code>string</code> values indexed by <code>int</code> keys)</li>
</ul>

<h2 id="consistent-array-manipulation-functions">Consistent array manipulation functions</h2>

<p>Standard PHP functions for array manipulation aren't very consistent or strict:</p>

<ul>
<li>most of them are not using strict comparison - they do automatic type conversion</li>
<li>most of them do not accept callbacks to create more complicated logic</li>
<li><a href="http://php.net/array_filter">some</a> accept the source array as first parameter, <a href="http://php.net/array_map">some</a> as a second parameter</li>
</ul>

<p>Consistence provides <a href="https://github.com/consistence/consistence/blob/master/docs/Type/arrays.md">several array manipulation functions</a> in the <code>ArrayType</code> namespace. Let's have a look at the examples.</p>

<p>In the first example you can see how the implicit type conversion in <code>in_array</code> function can lead to unexpected results:</p>

<pre><code class="php">&lt;?php
use Consistence\Type\ArrayType\ArrayType;

$data = ['1', '2'];

// automatic type conversion
in_array('1', $data); // bool(true)
in_array(1, $data); // bool(true) &lt;- unexpected result!
in_array(true, $data); // bool(true) &lt;- unexpected result!

// strict flag set to true
in_array('1', $data, true); // bool(true)
in_array(1, $data, true); // bool(false) &lt;- works as expected
in_array(true, $data, true); // bool(false) &lt;- works as expected

// ArrayType::containsValue() works as expected by default
ArrayType::containsValue($data, '1'); // bool(true)
ArrayType::containsValue($data, 1);  // bool(false)
ArrayType::containsValue($data, true);  // bool(false)
</code></pre>

<p>In this case you can get away with just making sure to always add <code>true</code> as a third parameter.</p>

<p>The code gets more complicated when you need more complex logic, e.g. you want to check if the array contains a value larger than 3. You can iterate through the array and determine if some value matches the condition:</p>

<pre><code class="php">&lt;?php
$data = [1, 2, 3, 4];

$result = false;
foreach ($data as $value) {
    if ($value &gt; 3) {
        $result = true;
        break;
    }
}
var_dump($result); // bool(true)
</code></pre>

<p>Consistence provides more succinct way of doing it with <code>containsValueByValueCallback()</code>, where you only need to write the actual business logic and not the repetitive boilerplate code:</p>

<pre><code class="php">&lt;?php
use Consistence\Type\ArrayType\ArrayType;

$data = [1, 2, 3, 4];

$result = ArrayType::containsValueByValueCallback($data, function (int $value) {
    return $value &gt; 3;
});

var_dump($result); // bool(true);
</code></pre>

<p>I often use array filtering by callback:</p>

<pre><code class="php">&lt;?php
use Consistence\Type\ArrayType\ArrayType;

$data = [1, 2, 3, 4];

$result = ArrayType::filterValuesByCallback($data, function (int $value): bool {
    return $value &gt; 2;
});
var_dump($result); // [3, 4]
</code></pre>

<p>And mapping values by callback:</p>

<pre><code class="php">&lt;?php
use Consistence\Type\ArrayType\ArrayType;

$data = [1, 2, 3, 4];

// map values using callback
$result = ArrayType::mapValuesByCallback($data, function (int $value) {
    return $value * 2;
});
var_dump($result); // [2, 4, 6, 8]
</code></pre>

<p>Sometimes it may be convenient to use <code>filterByCallback()</code> and <code>mapByCallback()</code> that pass both <em>key</em> and <em>value</em> to the callback function (they use the <a href="https://github.com/consistence/consistence/blob/master/docs/Type/arrays.md#keyvaluepair"><code>KeyValuePair</code></a> value object internally).</p>

<p>Did you know, that <code>array_unique()</code> is always comparing loosely? Therefore, I prefer to use strict <code>ArrayType::uniqueValues()</code>:</p>

<pre><code class="php">&lt;?php
use Consistence\Type\ArrayType\ArrayType;

$data = [1, '1', true];

var_dump(array_unique($data)); // ['1']
var_dump(ArrayType::uniqueValues($data)); // [1, '1', true]
</code></pre>

<p>Last thing I want to show you regarding the arrays is the <code>find</code>/<code>get</code> convention. If the method name starts with <code>find</code> (e.g. <code>findValue()</code>), it can either return the value or <code>null</code>. But if the method name starts with <code>get</code> (e.g. <code>getValue()</code>), it either returns the value or throws an exception.</p>

<pre><code class="php">&lt;?php
use Consistence\Type\ArrayType\ArrayType;

$data = [1, 2, 3, 4];

// we want to get a value at key

ArrayType::findValue($data, 3); // int(4)
ArrayType::findValue($data, 5); // null

ArrayType::getValue($data, 3); // int(4)
ArrayType::getValue($data, 5); // throws ElementDoesNotExistException
</code></pre>

<p>And there is more, <a href="https://github.com/consistence/consistence/blob/master/src/Type/ArrayType/ArrayType.php">have a look at the available methods</a> for yourself.</p>

<h2 id="regex">Regex</h2>

<p>This chapter is going to be a short one. Consistence provides a <code>preg_match</code> wrapper with more sensible API and exceptions error handling:</p>

<pre><code class="php">&lt;?php
use Consistence\RegExp\RegExp;

// you can either check if the string matches the pattern
RegExp::matches('abc', '/bc+/'); // bool(true)

// or get the matches back
$matches = RegExp::match('abcde', '/[b-d]+/');
var_dump($matches); // ['bcd']
</code></pre>

<h2 id="phpstan-integration">PHPStan integration</h2>

<p>There is a static analysis tool called <a href="https://github.com/phpstan/phpstan">PHPStan</a> (you can read more about it in <a href="https://medium.com/@ondrejmirtes/phpstan-2939cd0ad0e3">Ondřej's blogpost</a>.</p>

<p>I have created <a href="https://github.com/mhujer/phpstan-consistence">PHPStan rules for the Consistence library</a>. There is one which checks that the class extends <code>ObjectPrototype</code> or uses <code>ObjectMixinTrait</code>. And second which checks that you are using safer Consistence array manipulation functions instead of the plain native PHP ones.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In the article I've described the most interesting parts of the <a href="https://github.com/consistence/consistence/">Consistence</a> library. My favourite are enums and strict types everywhere.</p>

<p>If you are not using the Consistence library yet, <a href="https://github.com/consistence/consistence/#consistence">give it a try</a>!</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Málaga - co vidět a kam na výlety? Podruhé.]]></title>
            <link href="https://blog.martinhujer.cz/malaga-podruhe/"/>
            <updated>2018-01-27T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/malaga-podruhe/</id>
            <content type="html"><![CDATA[<p>Letos v lednu (12. - 26.1.) jsem znovu vyrazil do Málagy za teplem. Našel jsem spoustu dalších zajímavých věcí, které stojí za to navštívit. Navazuji na <a href="/malaga/">předchozí článek o Málaze</a>, takže si určitě pročtěte i ten.</p>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/nocni-malaga.jpg" alt="Noční Málaga" /></p>

<h2 id="doprava">Doprava</h2>

<ul>
<li><p>Uber v Málaze nefunguje, ale můžete místo něj použít Cabify.</p></li>
<li><p>Ve městě jezdí spoustu autobusů, spoje jdou vyhledávat v Google Maps. Nejpohodlnější je koupit si kartu na autobus (€1.7) a dobít si 10 jízdami za €8.30. Kartu jsem kupoval v <a href="https://goo.gl/maps/nvS6DsJV6Lp">prodejně v centru</a>.</p></li>
<li><p>Teoreticky by na tu kartu na autobus mělo jít za €5 aktivovat možnost půjčování kol <a href="http://malagabici.malaga.eu/webpublica/index.html">Malagabici</a>. Nedá se to vyřešit v té prodejně v centru (kde jsem kupoval kartu), ale je potřeba dojít do kanceláře na <a href="https://goo.gl/maps/B9sQMbAk5ik">Estación de María Zambrano</a>. Jo a prý tam jsou asi jen do 15 h (nemám vyzkoušeno).</p></li>
<li><p>Z letiště i zpátky na letiště jsem jel vlakem, lístek stojí 1.8€. Zpátky jsem letěl v 7:00 ráno s Ryanairem a v pohodě stačilo jet vlakem v 5:20. Pokud byste chtěli větší rezervu, tak bych doporučoval to Cabify.</p></li>
</ul>

<h2 id="co-nav%E5%A1t%E3%ADvit">Co navštívit</h2>

<ul>
<li><strong><a href="https://goo.gl/maps/KY7EYBZPeRo">Cementerio Inglés de Málaga</a></strong> - anglikánský hřbitov, stojí za návštěvu. Pozor, mají jen do 15 h. Vstup 4€.</li>
</ul>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/english-cemetery.jpg" alt="Enflish Cemetery" /></p>

<ul>
<li><p><strong><a href="https://goo.gl/maps/6fdFhjN2R362">Museo de Málaga</a></strong> - parádní muzeum. V prvním patře umění (vynechal jsem), v druhém patře archeologie (super). Vstup zdarma, zavřeno v pondělí.</p></li>
<li><p><strong><a href="https://goo.gl/maps/jZsESU6z89N2">Parque de Málaga</a></strong> - park v centru, víceméně je to botanická zahrada s fontánkami.</p></li>
<li><p><strong><a href="https://goo.gl/maps/gpVYjhu8N4F2">Parque del Oeste</a></strong> - obrovský park v Huelinu, je v něm obrovské jezírko s fontánou a želvami, palmy, papoušci, pštrosi a tak.</p></li>
</ul>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/park.jpg" alt="Parque del Oeste" /></p>

<ul>
<li><strong><a href="https://goo.gl/maps/Fz6mMb15rBR2">Plaza de toros de La Malagueta</a></strong> - býčí aréna, myslím že se tam něco děje jen v srpnu. Zvenku to moc zábavné není. Ale je na ní super výhled shora. Viz další tip.</li>
</ul>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/malagueta.jpg" alt="Malagueta" /></p>

<ul>
<li><p><strong><a href="https://goo.gl/maps/7gaj7Au1stp">Mirador de Gibralfaro</a></strong> - na tuhle vyhlídku narazíte cestou na Castillo de Gibralfaro. Je z ní super výhled na město, moře i arénu. Zajímavost je, že většina lidí, co tam dorazí, se nejdříve otočí zády a fotí selfie místo toho, aby se koukali. Z vyhlídky kromě přímé cesty na hrad vede i trošku okružní turistická, odkud je ještě <a href="https://mapy.cz/s/2lkbz">lepší výhled na Malaguetu</a> než z té vyhlídky. A cestu na hrad to prodlouží jen o pár set metrů. Tady místo Google Maps doporučuji offline Mapy.cz, kde je zanesená i tahle turistická trasa.</p></li>
<li><p><strong><a href="https://goo.gl/maps/enbGCeSWXWG2">Mirador de Alcazaba</a></strong> - vyhlídka před Alcazabou. Jde se tam po schodech za vlevo za vstupem do Teatro Romano. Zadarmo.</p></li>
<li><p><strong><a href="https://goo.gl/maps/NbhSr75V6Y32">Teatro Romano</a></strong> - římský amfiteátr. Má docela zajímavou historii, objevili ho až někdy v půlce 20. století, když dělali terénní práce u dostavěného <em>Casa de Cultura</em>. Ten nakonec zbourali (v roce 1995), protože zjistili, že kus toho amfiteátru je pod ním. A Teatro Romano otevřeli k prohlídkám až v roce 2011.</p></li>
<li><p><strong><a href="https://goo.gl/maps/7cGLNoWayFz">Alcazaba</a></strong> - arabská pevnost, hezky zachovalá. Vstupné myslím 2.5€.</p></li>
<li><p><strong><a href="https://goo.gl/maps/5rBJZmTGdsM2">Mercado de Huelin</a></strong> - trh s ovocem, zeleninou, masem, rybami a mořskými plody. Typicky tam chodí jen místní.</p></li>
<li><p><strong><a href="https://goo.gl/maps/ykA3NQMye5T2">La Taberna del Pintxo</a></strong> - tapas bar, kde hlavní roli hrají "Pintxos" (čti <em>pinčos</em>). Jsou to vlastně obložené chlebíčky, ale hodně vymazlené. A mají "párátko". Funguje to tak, že si sami chodíte na bar a vybíráte si z nabídky chlazených. A zároveň nosí z kuchyně tácy s teplými pintxos, prochází mezi stoly a pokud chcete, tak si nějaké vezmete. A při placení vám spočítají, kolik máte "párátek". Jo a mají tam na výběr i minidortíky.</p></li>
<li><p><strong><a href="https://goo.gl/maps/maeTtNBpdTC2">Santa Canela Café-Crepería</a></strong> - výborná hipster kavárna ve centru. Kromě standardních espressových káv umí i různé filtrované (Chemex, V60, aeropress). A mají v nabídce i různé druhy kávy (zrnek).</p></li>
</ul>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/santa-canela.jpg" alt="Kavárna Santa Canela" /></p>

<ul>
<li><p><strong><a href="https://goo.gl/maps/7UR5o9T43pH2">El Último Mono Juice &amp; Coffee</a></strong> - dobrá káva v centru. Nabízejí i smoothie apod.</p></li>
<li><p><strong><a href="https://goo.gl/maps/erkhecitmJC2">La Esperanza de los Ascurra</a></strong> - jedna z mnoha restaurací. Tuhle doporučila Airbnb hostitelka z bytu, kde bydlela ségra s partou, když přijeli na víkend do Málagy. Mají fajn nabídku mořských plodů (třeba chobotnici - pulpo). Takže pokud stejně jako já máte problém si vybrat kam jít, tak můžete třeba sem.</p></li>
<li><p><strong><a href="https://goo.gl/maps/GqqJ9u8JTQA2">Café Club Carambuco</a></strong> - fajn kavárna v Huelinu. Mají dobrou kávu, zapečené bagety a taky různé dortíky, byl jsem tam několikrát.</p></li>
</ul>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/carambuco.jpg" alt="Café Club Carumbuco" /></p>

<ul>
<li><strong><a href="https://goo.gl/maps/FJXvgj59tuv">Desembocadura del Guadalhorce</a></strong> - epická přírodní rezervace s mokřady. Mají tam dokonce pozorovatelny na sledování ptáků. Za mě jedna z top věcí v Málaze. Akorát to je trochu daleko a cestou si trochu zajdete, protože tam kde by se to hodilo, není most. Opět doporučuju Mapy.cz, kde jsou vyznačené i jednotlivé pozorovatelny. Nejlepší byla <a href="https://mapy.cz/s/2lkRb">Observatorio Laguna Grande</a>.</li>
</ul>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/rezervace.jpg" alt="Výhled na lagunu v Desembocadura del Guadalhorce" /></p>

<ul>
<li><strong><a href="https://goo.gl/maps/x4QXMGXgdBx">Monte San Antón</a></strong> - baví mě najít nějaký kopec a vylézt na něj. Tady jsem našel jeden, na který se dá docela hezky dojít, je to jen 500 výškových metrů. Dojel jsem autobusem <a href="https://goo.gl/maps/ZamQanDAWz12">dole pod kopec</a> a vyšlápnul si to nahoru. Část cesty je skrz hodně pěknou vilovou čtvrť. Nahoru a dolů mi to zabralo 3 h včetně půlhodinové svačiny a rozhlížení se nahoře. Cestou se jde skrz hezkou vilovou čtvrť. Prý je to top místo, kde se dá v Málaze bydlet, domy stojí od milionu eur výš. <a href="https://www.wikiloc.com/hiking-trails/malaga-san-anton-22221191">Záznam trasy na Wikiloc</a>. (na fotce je výhled na Málagu)</li>
</ul>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/vyhled-ze-san-anton.jpg" alt="Výhled na Málagu ze San Antón" /></p>

<ul>
<li><strong><a href="https://goo.gl/maps/Wu6XC2xMpqr">Restaurante Hermanos Muñoz</a></strong> - když jsem sešel dolů z kopce, tak jsem dostal chuť dát si něco dobrého. Vybral jsem tuhle restauraci a bylo to super. Měl jsem rosadu, což je nějaká ryba. A hlavně jsem zkusil <em>espeto de sardinas</em>, což jsou sardinky pečené na ohni napíchnuté na tyčce. Jí se tak, že oloupete maso z obou stran páteře (jí se i ta opečená kůže) a necháte hlavu, ocas a páteř.</li>
</ul>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/sardinky-before.jpg" alt="Sardinky - before" /></p>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/sardinky-after.jpg" alt="Sardinky - after" /></p>

<ul>
<li><p><em><strong>Chiringuito</strong></em> je obecný název pro restauraci/stánek s jídly z ryb a mořských plodů u pláže. Ty sardinky typicky mají ve všech.</p></li>
<li><p><strong><a href="https://goo.gl/maps/GcfumeK2uko">Merendero Casa Jose</a></strong> - chiringuito, kolem kterého jsem šel nekolikrát, takže jsem si tam poslední den zašel na oběd. Měl jsem grilované krevety a pak ještě sardinky a bylo to moc dobré. A domluvíte se tam i anglicky (já tedy mluvil španelsky, ale pak přišli nějací turisti a jeden číšník si to anglicky dával dost dobře).</p></li>
</ul>

<p><img src="/data/2018/2018-01-27-malaga-podruhe/merendero.jpg" alt="Krevety v Merendero Casa Jose" /></p>

<ul>
<li><p><strong><a href="https://goo.gl/maps/VJH6KkeKmsM2">Primark</a></strong> - naschvál jsem si sebou vezl méně triček a radši jsem si koupil čtyři jednobarevná bavlněná v Primarku po 2€ za kus.</p></li>
<li><p><strong><a href="https://goo.gl/maps/FHfUjaEhKxL2">Decathlon</a></strong> - stejně tak jsem si sebou nebral tepláky na doma a koupil jsem si je tady v Decathlonu. Plánoval jsem si totiž stejně pořídit nové a takhle je povezu jen jednu cestu. Jo a funguje tu Decathlon kartička z českého Decathlonu (díky <a href="https://play.google.com/store/apps/details?id=cz.tomatolabs.portmonka&amp;hl=en">Portmonka</a>).</p></li>
<li><p><strong><a href="https://goo.gl/maps/r3uCze6TSMR2">Informační centrum</a></strong> v centru - doporučuji si dojít pro mapu, kde jsou vyznačené různé památky, případně si nechat něco doporučit. Ale s Google Maps si klidně vystačíte.</p></li>
</ul>

<h2 id="zaj%E3%ADmavosti">Zajímavosti</h2>

<ul>
<li><p>od 22 h do 8 h se nesmí prodávat alkohol jinde než v restauracích a barech. Takže by vám večerce neměli prodat láhev tvrdého. Neměli by.</p></li>
<li><p>Pokud budete v Málaze poprvé, tak můžete vyzkoušet nějakou <em>free guided tour</em>. Obecně to funguje tak, že si nějakou najdete, zúčastníte se a pak jim něco zaplatíte podle toho, jak jste byli spokojení. (nemám vyzkoušeno)</p></li>
<li><p>Jedno odpoledne se ze slunečného dne během chvíle udělala hustá mlha. Hledal jsem a říká se tomu <a href="http://malagaenelcorazon.com/niebla-taro-en-malaga/">mlha Taró</a>.</p></li>
<li><p>Výběry z většiny bankomatů stojí kolem 2€ navíc se zahraniční kartou (i s <a href="/revolut-karta/">Revolut kartou</a>). Ale kupodivu Unicaja je má (zatím) zdarma, takže hledejte tu.</p></li>
</ul>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Keep your YAML files sorted with YAML sort checker]]></title>
            <link href="https://blog.martinhujer.cz/yaml-sort-checker/"/>
            <updated>2018-01-17T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/yaml-sort-checker/</id>
            <content type="html"><![CDATA[<p>Last year I've created a PHP tool <a href="https://github.com/mhujer/yaml-sort-checker">YAML file sort checker</a> that checks that YAML files in project are sorted alphabetically.</p>

<h2 id="why-should-you-sort-everything-alphabetically%3F">Why should you sort everything alphabetically?</h2>

<p>You can prevent unnecessary merge conflicts if you keep everything sorted. You should sort not only YAML files, but also <code>composer.json</code> (<code>require</code>, <code>require-dev</code> and <code>scripts</code> sections), <code>use</code> in PHP classes and any PHP array where order is not significant.</p>

<p>Typical situation is when two developers register a new service in <code>services.yml</code>. If they both add it to the end, it will inevitably lead to a merge conflict. However, when the services are alphabetically sorted, the probability of merge conflict is much lower, because the services will be probably added to different places and therefore won't clash.</p>

<p>(This specific example got better with new DI improvements in recent Symfony versions, where you don't need to register that many services manually)</p>

<p><strong>Tip:</strong> You can use AlphabeticallySortedUses sniff from <a href="https://github.com/slevomat/coding-standard#slevomatcodingstandardnamespacesalphabeticallysorteduses-">Slevomat Coding Standard</a> to check that <code>use</code> in PHP class are sorted.</p>

<h2 id="installation">Installation</h2>

<p>YAML file sort checker is installed through Composer:</p>

<pre><code class="bash">composer require --dev mhujer/yaml-sort-checker
</code></pre>

<h2 id="configuration">Configuration</h2>

<p>You have to create a configuration file <code>yaml-sort-checker.yml</code> in the project root directory. Then list all files that should be checked in it.</p>

<p>The initial config may look like this:</p>

<pre><code class="yaml">files:
    app/config/services.yml:
        depth: 2

    yaml-sort-checker.yml:
</code></pre>

<p>It checks <code>services.yml</code> and itself. The <code>services.yml</code> will be validated only two levels deep.</p>

<p>Sometimes you may want to exclude some keys from validation. It can be accomplished by using <code>excludedKeys</code> option. You can see how the exclusion works in the example bellow:</p>

<pre><code class="yaml">files:
    app/config/config_prod.yml:
        excludedKeys:
            monolog:
                handlers:
                    main:
                        - type
                    nested:
                        - type

    app/config/config_test.yml:
        excludedKeys:
            0: imports
</code></pre>

<h2 id="run-the-checker">Run the checker</h2>

<p>After you have created a configuration file, you can run the checker:</p>

<pre><code class="bash">vendor/bin/yaml-sort-checker
</code></pre>

<h2 id="phpstorm-integration">PHPStorm integration</h2>

<p>It is possible to integrate YAML sort checker with PHPStorm using File Watchers. It is described in the <a href="https://github.com/mhujer/yaml-sort-checker#phpstorm-integration">project README on github</a> so I won't duplicated it here.</p>

<h2 id="conclusion">Conclusion</h2>

<p>It is a good practice to keep most of the things sorted alphabetically to prevent merge conflicts. However, it can be a tedious task to do manually. Luckilly the YAML files can be automatically checked with <a href="https://github.com/mhujer/yaml-sort-checker">YAML file sort checker</a>.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Have you tried Composer Scripts? You may not need Phing.]]></title>
            <link href="https://blog.martinhujer.cz/have-you-tried-composer-scripts/"/>
            <updated>2018-01-14T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/have-you-tried-composer-scripts/</id>
            <content type="html"><![CDATA[<p>Phing is a great tool (I'm using it as well), but in this article, I want to show you that some projects may not need it. Composer contains a powerful feature called "<a href="https://getcomposer.org/doc/articles/scripts.md">Scripts</a>", which can be used to create a simple build script.</p>

<blockquote>
  <p>If you haven't read it yet, I suggest that you read my article <a href="/17-tips-for-using-composer-efficiently/">17 Tips for Using Composer Efficiently</a> before reading this one.</p>
</blockquote>

<h2 id="creating-a-build-script-for-launching-php_codesniffer">Creating a build script for launching PHP_CodeSniffer</h2>

<p>Let's say that you have installed PHP_CodeSniffer and you run it with this command:</p>

<pre><code class="bash">vendor/bin/phpcs --standard=PSR2 src
</code></pre>

<p>You probably want your colleagues and CI server to run it with the same parameters. To do so, you need to store it somewhere. You can either create a <code>build.xml</code> for Phing or put it in a bash script (and batch file to cover Windows). Or you can leverage the power of Composer scripts.</p>

<p>Put the command to the <code>composer.json</code> file with all its parameters:</p>

<pre><code class="json">  "scripts": {
      "phpcs": "phpcs --standard=PSR2 src"
  }
</code></pre>

<p>And run it this way:</p>

<pre><code class="bash"># either explicitly:
composer run-script phpcs

# or via shortcut:
composer phpcs
</code></pre>

<h2 id="tip%3A-use-alias-for-running-composer">Tip: Use alias for running Composer</h2>

<p>If you are launching Composer by typing <code>composer</code> (or even <code>php composer.phar</code>) every time, you may want to save time by creating an alias for it.</p>

<p>On Windows, you need to create a <code>.cmd</code> file in a directory which is in the system PATH. I've created <code>c:\dev\php\x.cmd</code> with this content (<code>%*</code> passes through all the parameters):</p>

<pre><code class="bash">php c:\devweb\php\composer.phar %*
</code></pre>

<p>On Linux, you can add an alias to <code>~/.bashrc</code>:</p>

<pre><code>alias x="composer"
</code></pre>

<p>Now you can run Composer just by typing <code>x</code> and a command (e.g. <code>x phpcs</code>).</p>

<h2 id="tip%3A-don%27t-type-whole-composer-command-name">Tip: Don't type whole Composer command name</h2>

<p>Because Composer CLI is powered by Symfony Console, you can save some characters on unambiguous commands. Instead of writing <code>composer update</code>, it is enough to write <code>composer up</code> (or only <code>x up</code> if you also applied the previous tip)</p>

<h2 id="creating-more-complex-build-script">Creating more complex build script</h2>

<p>Let's start with an example:</p>

<pre><code class="json">  "scripts": {
      "ci": [
          "@phpcs",
          "@test"
      ],
      "phpcs": "phpcs --standard=PSR2 src",
      "test": "phpunit"
  }
</code></pre>

<p>I've added a new script called <code>test</code> which just launches PHPUnit with default configuration.</p>

<p>The <code>ci</code> script is more interesting. It is not an actual script, but a meta-script that references several other scripts. The referenced scripts are prefixed by <code>@</code>. This way, you can create more complex scripts without duplication.</p>

<h2 id="launching-composer-or-php-from-scripts">Launching Composer or PHP from scripts</h2>

<p>You can use the <code>@composer</code> and <code>@php</code> commands to launch the same Composer or PHP executable that is running the script.</p>

<p>For example you may want to validate the <code>composer.json</code> file during CI build:</p>

<pre><code class="json">  "scripts": {
      "ci": [
          "@composer validate --no-check-all --strict",
          ...
      ]
  }
</code></pre>

<p>Or you want to use YAML validation that is available as a Symfony Console command:</p>

<pre><code class="json">"scripts": {
    "yamllint": "@php bin/console lint:yaml app"
}
</code></pre>

<h2 id="don%27t-forget-to-document-the-custom-scripts">Don't forget to document the custom scripts</h2>

<p>You can use the <code>scripts-descriptions</code> section to document what custom scripts do:</p>

<pre><code class="json">"scripts-descriptions": {
    "phpcs": "Checks that the application code conforms to coding standard",
    "test": "Launches the preconfigured PHPUnit"
}
</code></pre>

<h2 id="configure-timeout-for-long-running-scripts">Configure timeout for long-running scripts</h2>

<p>If you have some long-running scripts, you should configure the process timeout. It defaults to <code>300</code> which means that Composer will terminate the script after 300s. You can either set a specific time limit in seconds, or <code>0</code> for unlimited.</p>

<p>Timeout can be configured in the ENV variable <code>COMPOSER_PROCESS_TIMEOUT</code>:</p>

<pre><code class="bash">export COMPOSER_PROCESS_TIMEOUT=600
</code></pre>

<p>Or by adding <code>--timeout=0</code> argument when running the script:</p>

<pre><code class="bash">composer phpunit --timeout=3600
</code></pre>

<p>Or in <code>config</code> section of <code>composer.json</code>:</p>

<pre><code class="json">"config": {
    "process-timeout": 0
}
</code></pre>

<h2 id="tips-for-the-scripts%3A">Tips for the Scripts:</h2>

<ol>
<li><p>You can use <code>composer run-script --list</code> to list custom scripts.</p></li>
<li><p>Be careful not to create a script with a name conflicting with the existing Composer command. Composer throws a warning on every run when such a script is present in <code>composer.json</code>.</p></li>
<li><p>You don't have to update <code>composer.lock</code> when adding or changing the scripts, because they are not included in <code>composer.lock</code> at all.</p></li>
<li><p>You can even <a href="https://getcomposer.org/doc/articles/scripts.md#defining-scripts">call PHP callbacks from scripts</a> (Static methods in classes autoloadable by Composer). But I don't recommend using them for build scripts because potential migration to other build system would be hard.</p></li>
</ol>

<h2 id="when-should-i-switch-to-phing%3F">When should I switch to Phing?</h2>

<p>Composer Scripts are great for simple build scripts. But it is important to recognize the moment when the build script is so complex, that a dedicated build tool would do better.</p>

<p>As a rule of thumb, you shouldn't do any files / directories manipulation in Composer scripts (as it would be hard to do it Linux/Windows compatible) and switch to Phing instead.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Composer scripts are a lightweight tool to create build scripts. However, it is important to know when to switch to a dedicated tool such as Phing.</p>

<p>Do you like them?</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[17 Tips for Using Composer Efficiently]]></title>
            <link href="https://blog.martinhujer.cz/17-tips-for-using-composer-efficiently/"/>
            <updated>2018-01-05T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/17-tips-for-using-composer-efficiently/</id>
            <content type="html"><![CDATA[<p>Although most PHP developers know how to use Composer, not all of them are using it efficiently or in a best possible way. So I decided to summarize things which are important for my everyday workflow.</p>

<p>The philosophy of most of the tips is <em>"Play it safe"</em>, which means that if there are more ways how to handle something, I would use the approach which is least error-prone.</p>

<h2 id="tip-%231%3A-read-the-documentation">Tip #1: Read the documentation</h2>

<p>I really mean it. <a href="https://getcomposer.org/doc/">The documentation</a> is great and a few hours of reading it will save you more time in the long run. You would be surprised how many things Composer can do.</p>

<h2 id="tip-%232%3A-be-aware-of-differences-between-a-%22project%22-and-a-%22library%22">Tip #2: Be aware of differences between a "project" and a "library"</h2>

<p>It's important to know, whether you are creating a <em>"project"</em> or a <em>"library"</em>. Each of them requires separate set of practices.</p>

<p>A library is a reusable package, that you would add as a dependency - such as <code>symfony/symfony</code>, <code>doctrine/orm</code> or <a href="https://github.com/elastic/elasticsearch-php"><code>elasticsearch/elasticsearch</code></a>.</p>

<p>A project is typically an application, that depends on several libraries. It is usually not reusable (no other projects would require it as a dependency). Typical example is an ecommerce website, customer support system etc.</p>

<p>I will distinguish between library and a project in the tips bellow.</p>

<h2 id="tip-%233%3A-use-specific-dependencies%27-versions-for-applications">Tip #3: Use specific dependencies' versions for applications</h2>

<p>If you are creating an application, you should use the most specific version to define the dependency. If you need to parse YAML files, you should specify the dependency like this <code>"symfony/yaml": "4.0.2"</code>.</p>

<p>Even if the library follows <a href="https://semver.org/">Semantic Versioning</a>, there may be backwards-compatibility breaks in the minor and patch versions. For example, if you are using <code>"symfony/symfony": "^3.1"</code>, there may be something deprecated in 3.2 which may break your application tests. Or there may be a bug fixed in PHP_CodeSniffer and it would detect new formatting issues in your code, which again may lead to a broken build.</p>

<p>The update of dependencies should be deliberate, not accidental. One of the tips bellow discusses it in greater detail.</p>

<p>It may sound as an overkill, but it will prevent your co-workers from accidentally updating all dependencies when adding a new library to project (which you may miss during Code Review).</p>

<h2 id="tip-%234%3A-use-version-ranges-for-libraries-dependencies">Tip #4: Use version ranges for libraries dependencies</h2>

<p>If you are creating a library, you should define the broadest version range possible. If you create a library that uses <code>symfony/yaml</code> library for YAML parsing, you should require it like this:</p>

<pre><code class="json">"symfony/yaml": "^3.0 || ^4.0"
</code></pre>

<p>It means that your library can utilize <code>symfony/yaml</code> from any Symfony 3.x or 4.x versions. It is important, because this constraint is passed to the application that uses your library.</p>

<p>In case there are two libraries with conflicting requirements, e.g. one requires <code>~3.1.0</code> and other requires <code>~3.2.0</code>, the installation would fail.</p>

<h2 id="tip-%235%3A-you-should-commit-%60composer.lock%60-to-git-in-applications">Tip #5: You should commit <code>composer.lock</code> to git in applications</h2>

<p>If you are creating <em>a project</em>, you definitely want to commit <code>composer.lock</code> to git. This ensures that everyone - you, your co-workers, your CI server and your production server - is running the application with the same dependencies versions.</p>

<p>At first glance, it may sound superfluous - you are already using a specific version in the constraint, as mentioned in the tip #3. But no, there are also the dependencies of your dependencies which are not bound by these constraints (e.g. <code>symfony/console</code> depends on <code>symfony/polyfill-mbstring</code>). So without committing the <code>composer.lock</code>, you won't get the exact same set of dependencies.</p>

<h2 id="tip-%236%3A-put-%60composer.lock%60-into-%60.gitignore%60-in-libraries">Tip #6: Put <code>composer.lock</code> into <code>.gitignore</code> in libraries</h2>

<p>If you are creating <em>a library</em> (let's call it <code>acme/my-library</code>), you should not commit a <code>composer.lock</code> file. It <a href="https://getcomposer.org/doc/02-libraries.md#lock-file">does not have any effect</a> on the projects that are using your library.</p>

<p>Imagine that the <code>acme/my-library</code> uses <code>monolog/monolog</code> as a dependency. If you have committed a <code>composer.lock</code>, everyone who is developing the <code>acme/my-library</code> would be using an older version of Monolog. But when the library is finished, and you use it in a real project, a newer version of Monolog may be installed, and it may not be compatible with the library. But you didn't notice it before, because of the <code>composer.lock</code>!</p>

<p>It is best to put <code>composer.lock</code> into your <code>.gitignore</code> so you won't commit it accidentally.</p>

<p>If you want to make sure that the library is compatible with different versions of its dependencies, read the next tip!</p>

<h2 id="tip-%237%3A-run-travis-ci-builds-with-different-versions-of-dependencies">Tip #7: Run Travis CI builds with different versions of dependencies</h2>

<blockquote>
  <p>This tip applies only to libraries (because you use specific versions for applications).</p>
</blockquote>

<p>If you are building an open-source library, you are probably using Travis CI for running its builds.</p>

<p>By default, Composer installs the latest possible versions of dependencies which are allowed by the constraints in <code>composer.json</code>. It means that for the dependency constraint <code>^3.0 || ^4.0</code>, the build would always use the latest version of the v4 release. As the 3.0 is never tested, the library may not be compatible with it and that would make your users sad.</p>

<p>Luckily, Composer provides a switch to install the lowest possible versions of dependencies <code>--prefer-lowest</code> (should be used with <code>--prefer-stable</code> to prevent installation of non-stable versions).</p>

<p>Updated <code>.travis.yml</code> configuration may look like this:</p>

<pre><code class="yaml">language: php

php:
  - 7.1
  - 7.2

env:
  matrix:
    - PREFER_LOWEST="--prefer-lowest --prefer-stable"
    - PREFER_LOWEST=""

before_script:
  - composer update $PREFER_LOWEST

script:
  - composer ci
</code></pre>

<p>See it live in <a href="https://github.com/mhujer/fio-api-php/blob/master/.travis.yml">my mhujer/fio-api-php library</a> and <a href="https://travis-ci.org/mhujer/fio-api-php">the build matrix on Travis CI</a></p>

<p>Even though this solution would catch most of the incompatibilities, remember that there are many combinations of dependencies between lowest and latest versions. And they may be incompatible together.</p>

<h2 id="tip-%238%3A-sort-packages-in-require-and-require-dev-by-name">Tip #8: Sort packages in require and require-dev by name</h2>

<p>It is a good practice to keep packages in <code>require</code> and <code>require-dev</code> sorted by name. It can prevent unnecessary merge conflicts when rebasing a branch. Because if you have added a package to the end of the list in two branches, there would be a merge conflict every time.</p>

<p>It is a tedious task to do manually, so it is best to <a href="https://getcomposer.org/doc/06-config.md#sort-packages">configure it</a> in <code>composer.json</code>:</p>

<pre><code class="json">{
...
    "config": {
        "sort-packages": true
    },
…
}
</code></pre>

<p>Next time, you <code>require</code> a new package, it will be added to a proper place (and not to the end).</p>

<h2 id="tip-%239%3A-do-not-attempt-to-merge-%60composer.lock%60-when-rebasing-or-merging">Tip #9: Do not attempt to merge <code>composer.lock</code> when rebasing or merging</h2>

<p>If you add a new dependency to <code>composer.json</code> (and <code>composer.lock</code>) and before your branch is merged, there is another dependency added in master, you need to rebase your branch. And you will get a merge-conflict in <code>composer.lock</code>.</p>

<p>You should never try to resolve this conflict manually, because the <code>composer.lock</code> file contains a hash of dependencies defined in <code>composer.json</code>. So even if you resolve the conflict, the resulting lock file would be incorrect.</p>

<p>Best thing to do is to create <code>.gitattributes</code> in the project root with the following line, which means that the git won't even attempt to merge the <code>composer.lock</code>:</p>

<pre><code class="ini">/composer.lock -merge
</code></pre>

<p>You can remedy this issue by using short-lived feature branches as suggested in <a href="https://trunkbaseddevelopment.com/">Trunk Based Development</a> (you should be doing this anyway). When you have a short-lived branch, which is merged promptly, the risk of merge conflict in <code>composer.lock</code> is minimal. You may even create a branch just for adding a dependency and merge it right away.</p>

<p>But what to do, if you encounter a merge conflict in <code>composer.lock</code> when rebasing? Resolve it with the version from master, so you will have changes only in <code>composer.json</code> (the newly added package). And then run <code>composer update --lock</code>, which will to update the <code>composer.lock</code> file with changes from <code>composer.json</code>. Now you can stage the updated  <code>composer.lock</code> and continue with the rebase.</p>

<h2 id="tip-%2310%3A-know-the-difference-between-%60require%60-and-%60require-dev%60">Tip #10: Know the difference between <code>require</code> and <code>require-dev</code></h2>

<p>It is important to be aware of the difference between <code>require</code> and <code>require-dev</code> blocks.</p>

<p>Packages which are required to run the application or library should be defined in <code>require</code> (e.g. Symfony, Doctrine, Twig, Guzzle, …). If you are creating a library, be careful about what you put to <code>require</code>. Because each dependency from this section is also a dependency of the application, which uses the library.</p>

<p>Packages necessary for developing the application (or library) should be defined in <code>require-dev</code> (e.g. PHPUnit, PHP_CodeSniffer, PHPStan).</p>

<h2 id="tip-%2311%3A-update-dependencies-safely">Tip #11: Update dependencies safely</h2>

<p>I guess we can agree on the fact that dependencies should be updated regularly. What I want to discuss here is that dependencies updating should be explicit and deliberate, not done just by-the-way with some other work. If you refactor something and at the same time update some library, you can't easily tell if the app was broken by the refactoring or by the update.</p>

<p>You can use <code>composer outdated</code> command to see what dependencies can be updated. It is a good idea to include <code>--direct</code> (or <code>-D</code>) switch to list only dependencies specified in <code>composer.json</code>. There is also a <code>-m</code> switch to list only minor version updates.</p>

<p><strong>For each outdated dependency follow these steps</strong>:</p>

<ol>
<li>Create a new branch</li>
<li>Update the dependency version in <code>composer.json</code> to the latest one</li>
<li>Run <code>composer update phpunit/phpunit --with-dependencies</code> (replace <code>phpunit/phpunit</code> with the library you are updating)</li>
<li>Check the CHANGELOG in the library repository on Github to see if there are any breaking changes. If so, update the application</li>
<li>Test the application locally (If you are using Symfony, you can find deprecation warnings in the Debug Bar)</li>
<li>Commit the changes (<code>composer.json</code>, <code>composer.lock</code> and anything else what was necessary for new version to work)</li>
<li>Wait for the CI build to finish</li>
<li>Merge and deploy</li>
</ol>

<p>Sometimes it makes sense to update more dependencies at once, e.g. when you are updating Doctrine or Symfony. In this case you can list them all in update command:</p>

<pre><code class="bash">composer update symfony/symfony symfony/monolog-bundle --with-dependencies
</code></pre>

<p>Or you can use a wildcard to update all dependencies from a specific namespace:</p>

<pre><code class="bash">composer update symfony/* --with-dependencies
</code></pre>

<p>I know that this all sounds tedious, but you will probably update dependencies just occasionally, so it is worth the extra safety.</p>

<p>One shortcut which is acceptable to make is to update all <code>require-dev</code> dependencies at once (if they do not require changes in the code, otherwise I would suggest using separate branches for easier code review).</p>

<h2 id="tip-%2312%3A-you-can-define-other-types-of-dependencies-in-%60composer.json%60">Tip #12: You can define other types of dependencies in <code>composer.json</code></h2>

<p>Apart from defining libraries as dependencies, you can also define other things there.</p>

<p>You can define, which PHP versions your application/library supports:</p>

<pre><code class="json">"require": {
    "php": "7.1.* || 7.2.*",
},
</code></pre>

<p>You can also define which extensions are required for the application/library. It is super-useful when you are trying to dockerize your application or your new colleague is setting-up the application for the first time.</p>

<pre><code class="json">"require": {
    "ext-mbstring": "*",
    "ext-pdo_mysql": "*",
},
</code></pre>

<p>(You should use <code>*</code> for the extensions version as <a href="https://getcomposer.org/doc/01-basic-usage.md#platform-packages">they may be a bit inconsistent</a>).</p>

<h2 id="tip-%2313%3A-validate-the-%60composer.json%60-during-the-ci-build">Tip #13: Validate the <code>composer.json</code> during the CI build</h2>

<p><code>composer.json</code> and <code>composer.lock</code> should be always kept in sync. Therefore, it is a good idea to have an automatic check for it. Just add this as a part of you build script and it will ensure that <code>composer.lock</code> is in sync with <code>composer.json</code>:</p>

<pre><code class="bash">composer validate --no-check-all --strict
</code></pre>

<h2 id="tip-%2314%3A-use-a-composer-plugin-in-phpstorm">Tip #14: Use a Composer plugin in PHPStorm</h2>

<p>There is a <a href="https://plugins.jetbrains.com/plugin/7631-php-composer-json-support">composer.json plugin for PHPStorm</a>. It adds autocompletion and some validations when changing <code>composer.json</code> manually.</p>

<p>If you are using other IDE (or just a code editor), you can setup validation against <a href="https://getcomposer.org/schema.json">its JSON schema</a>.</p>

<h2 id="tip-%2315%3A-specify-the-production-php-version-in-%60composer.json%60">Tip #15: Specify the production PHP version in <code>composer.json</code></h2>

<p>If you are like me and you are sometimes <a href="https://blog.martinhujer.cz/php-7-2-is-due-in-november-whats-new/">running pre-released PHP versions locally</a>, you are in risk of updating the dependencies to a version that won't work in production. Right now, I'm using PHP 7.2.0 which means, that I can install libraries, that would not work on 7.1. As the production is running 7.1, the installation would fail there.</p>

<p>But no need to worry, there is an easy way out. Just specify the production PHP version in <code>config</code> section of <code>composer.json</code>:</p>

<pre><code class="json">"config": {
    "platform": {
        "php": "7.1"
    }
}
</code></pre>

<p>Don't confuse it with <code>require</code> section, which behaves differently. Your application may be able to run on 7.1 or 7.2 and at the same time specify 7.1 as a platform (which means that the dependencies will be always updated to a version compatible with 7.1):</p>

<pre><code class="json">"require": {
    "php": "7.1.* || 7.2.*"
},
"config": {
    "platform": {
        "php": "7.1"
    }
},
</code></pre>

<h2 id="tip-%2316%3A-using-private-packages-from-self-hosted-gitlab">Tip #16: Using private packages from self-hosted Gitlab</h2>

<p>It is recommended to use <code>vcs</code> as a repository type and the Composer should determine the proper way of fetching the packages. For example, if you are adding a fork from Github, it would use its API to download the .zip file instead of cloning the whole repository.</p>

<p>But it is more complicated for a private Gitlab installation. If you use <code>vcs</code> as a repository type, Composer will detect that it is a Gitlab installation would try to download the package using the API (which requires an API key. I didn't want to set it up, so I settled for this setup (which uses SSH for cloning):</p>

<p>First specify the repository with the type <code>git</code>:</p>

<pre><code class="json">"repositories": [
    {
        "type": "git",
        "url": "git@gitlab.mycompany.cz:package-namespace/package-name.git"
    }
]
</code></pre>

<p>Then use the package as you would have normally:</p>

<pre><code class="json">"require": {
    "package-namespace/package-name": "1.0.0"
}
</code></pre>

<h2 id="tip-%2317%3A-how-to-temporarily-use-a-branch-with-bugfix-from-fork">Tip #17: How to temporarily use a branch with bugfix from fork</h2>

<p>If you find a bug in some public library and you fix it in your fork on Github, you need to install the library from this repository instead of the official one (until the bugfix is merged and fixed version is released).</p>

<p>It can be done easily with <a href="https://getcomposer.org/doc/articles/aliases.md#require-inline-alias">inline aliasing</a>:</p>

<pre><code class="json">{
    "repositories": [
        {
            "type": "vcs",
            "url": "https://github.com/you/monolog"
        }
    ],
    "require": {
        "symfony/monolog-bundle": "2.0",
        "monolog/monolog": "dev-bugfix as 1.0.x-dev"
    }
}
</code></pre>

<p>You can test the bugfix locally before pushing it by <a href="https://getcomposer.org/doc/05-repositories.md#path">using <code>path</code> as a repository type</a>.</p>

<h2 id="update-2018-01-08%3A">Update 2018-01-08:</h2>

<p>After publishing the article, I got suggestions for several more tips. So here they are:</p>

<h2 id="tip-%2318%3A-install-prestissimo-to-speed-up-package-installation">Tip #18: Install prestissimo to speed up package installation</h2>

<p>There is a Composer plugin <a href="https://github.com/hirak/prestissimo">hirak/prestissimo</a> which speeds up dependencies installation by downloading them in parallel.</p>

<p>And the best thing? You only need to install it once, globally and it will work automatically for all projects:</p>

<pre><code class="bash">composer global require hirak/prestissimo
</code></pre>

<h2 id="tip-%2319%3A-test-your-version-constraints-if-you-are-not-sure">Tip #19: Test your version constraints if you are not sure</h2>

<p>Writing correct version constraints may sometimes be tricky even after reading <a href="https://getcomposer.org/doc/articles/versions.md#writing-version-constraints">the documentation</a>.</p>

<p>Luckily, there is a <a href="https://semver.mwl.be/">Packagist Semver Checker</a> where you can check which versions match the specified constraint. Instead of only analysing the version constraint, it downloads the data from Packagist to display the actual released versions.</p>

<p>See <a href="https://semver.mwl.be/#?package=symfony%2Fsymfony&amp;version=%5E3.1&amp;minimum-stability=stable">the result for <code>symfony/symfony:^3.1</code></a>.</p>

<h2 id="tip-%2320%3A-use-authoritative-class-map-in-production">Tip #20: Use authoritative class map in production</h2>

<p>You should <a href="https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-a-authoritative-class-maps">generate authoritative class map</a> in production. It will speed-up class loading by including everything in class-map and skipping any filesystem checks.</p>

<p>You can do it by running this as a part of your production build:</p>

<pre><code class="bash">composer dump-autoload --classmap-authoritative
</code></pre>

<h2 id="tip-%2321%3A-configure-%60autoload-dev%60-for-tests">Tip #21: Configure <code>autoload-dev</code> for tests</h2>

<p>You don't want to include test files in production class map (because of the file size and memory). It can be done by configuring the <code>autoload-dev</code> (similarly to <code>autoload</code>):</p>

<pre><code class="json">"autoload": {
    "psr-4": {
        "Acme\\": "src/"
    }
},
"autoload-dev": {
    "psr-4": {
        "Acme\\": "tests/"
    }
},
</code></pre>

<h2 id="tip-%2322%3A-try-composer-scripts">Tip #22: Try Composer scripts</h2>

<p>Composer scripts are a lightweight tool to create build scripts. I have written <a href="/have-you-tried-composer-scripts/">a separate article about them</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>If you disagree with some of the tips, I would be happy if you can describe why in the comments (don't forget to put the tip number there).</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Madrid - co vidět a navštívit? Kam na výlety?]]></title>
            <link href="https://blog.martinhujer.cz/madrid/"/>
            <updated>2017-11-25T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/madrid/</id>
            <content type="html"><![CDATA[<p>S Ivčou jsme strávili jeden listopadový týden v Madridu. Centrum jsme prochodili křížem krážem a tady bych chtěl shrnout zajímavosti, které byste určitě neměli minout (a nebo naopak měli).</p>

<p><img src="/data/2017/2017-11-25-madrid/madrid-palacio.jpg" alt="Palacio Real de Madrid" /></p>

<h2 id="bydlen%E3%AD">Bydlení</h2>

<p>Bydleli jsme vedle parku <a href="https://goo.gl/maps/vg7atmVqA5B2">El Retiro</a>, takže to do centra byl kousíček.</p>

<h2 id="co-nav%E5%A1t%E3%ADvit">Co navštívit</h2>

<p>(seznam není nijak seřazený)</p>

<p>Ve všední dny mají některá muzea a galerie navečer vstup zdarma (doporučuji čas vždycky ověřit na jejich webu).</p>

<ul>
<li><p><strong><a href="https://goo.gl/maps/B59SSdNbeQp">Parque de El Retiro</a></strong> - obrovský park v centru města. Najdete v něm i růžovou zahradu nebo pávy.</p></li>
<li><p><strong><a href="https://goo.gl/maps/Z1wSFxsyGGF2">Estanque grande del Retiro</a></strong> - ještě chvíli zůstaneme v El Retiro, protože v něm je taky jezírko, kde si jde půjčit lodičku (Myslím, že za 6€). Pokud bude hezké počasí, tak to určitě stojí za to. A doporučuji všední den, o víkendu tam byla dost fronta.</p></li>
<li><p><strong><a href="https://goo.gl/maps/DXA85mp5pr72">Atocha Cercanías</a></strong> - vlakové nádraží, které uvnitř obsahuje botanickou zahradu. Včetně jezírka se spoustou želviček.</p></li>
<li><p><strong><a href="https://goo.gl/maps/E5NRAAY5vr62">Real Jardín Botánico</a></strong> - botanická zahrada, kde toho bylo dost k vidění i v listopadu. Mají tam výstavku bonsají. A super skleníky. Vstup 4€.</p></li>
<li><p><strong><a href="https://goo.gl/maps/vaNcEfiKV532">Casa Museo Lope de Vega</a></strong> - muzeum Lope de Vega, mají prohlídku zdarma, ale je potřeba se <a href="http://www.casamuseolopedevega.org/es/actividades/visitas-guiadas">dopředu objednat e-mailem</a>. A prohlídky umí i v angličtině ;-)</p></li>
<li><p><strong><a href="https://goo.gl/maps/j6n8YJpEPS62">El Rastro</a></strong> - trh každou neděli dopoledne. Původně to prý byl blešák, ale mně to přišlo spíš jako obyčejná tržnice.</p></li>
<li><p><strong><a href="https://goo.gl/maps/4WMSBgbqwCS2">Chocolatería San Ginés</a></strong> - prodávají churros už od roku 1894. Zajímavostí je, že mají otevřeno 24 hodin denně. Ať vás nepřekvapí, že v rámci efektivity se neobjednává u stolu, ale nejdříve vystojíte frontu a objednáte si u baru. Teprve pak si sednete a nějaký číšník si od vás vezme lísteček s objednávkou.</p>

<p><img src="/data/2017/2017-11-25-madrid/churros.jpg" alt="Churros" /></p></li>
<li><p><strong><a href="https://goo.gl/maps/ZS5Huqk37n42">Mercado de San Miguel</a></strong> - street food market s různými tradičními španělskými jídly (různé rybí pochoutky, croquetas, jamón, olivy, apod.). Nás víc bavil <a href="https://goo.gl/maps/edsstngGqc52">Mercado San Anton</a>, kde bylo méně lidí.</p></li>
<li><p><strong><a href="https://goo.gl/maps/MmxDmnYupXU2">Museo Nacional del Prado</a></strong> - do Prada jsme nakonec vůbec nešli, protože nás obrazy moc nebaví. Ke konci dne mají vstup zdarma a to tam je prý dost narváno.</p></li>
<li><p><strong><a href="https://goo.gl/maps/Hms9xkFdpSN2">Museo Naval de Madrid</a></strong> - muzeum španělského námořnictví. A že mají co ukazovat! Bylo to parádní a vstupné jen 3€.</p></li>
<li><p><strong><a href="https://goo.gl/maps/nfgyYRWX8AJ2">Museo de Historia de Madrid</a></strong> - muzeum historie Madridu. Vstup zdarma. A popisky i v angličtině.</p></li>
<li><p><strong><a href="https://goo.gl/maps/kvFYdGSUcmt">Teleférico de Madrid</a></strong> - městská lanovka, odveze vás do Caso de Campo. Byla tam docela fronta, ale zážitek pěkný.</p></li>
<li><p><strong><a href="https://goo.gl/maps/JQwExGNuugA2">Caso de Campo</a></strong> - sem vás doveze lanovka. Je to obrovský park nebo možná spíš "les". Místní tam jezdí na pikniky. Zpátky můžete zas jet lanovou nebo klidně dojít pěšky.</p></li>
<li><p><strong><a href="https://goo.gl/maps/hwBYb1gXY1A2">Primark</a></strong> - čtyřpatrový Primark je epic. Ale nakonec jsme nic nekoupili, protože tam bylo hrozně moc lidí a dlouhé fronty na kabinky.</p></li>
<li><p><strong><a href="https://goo.gl/maps/QCwDVE6bhk22">Catedral de la Almudena</a></strong> - hezká katedrála</p></li>
<li><p><strong><a href="https://goo.gl/maps/8ksaSVjckG92">Campo del Moro</a></strong> - velký park za královským palácem. Pozor, má to <a href="https://goo.gl/maps/n8DzGUtjfDt">jen jeden vstup</a>.</p></li>
<li><p><strong><a href="https://goo.gl/maps/7aKv7Nm4rrJ2">CentroCentro</a></strong> - kulturní centrum. Mají tam nějaké haluzné výstavy a něco jako coworking (wifi, stoly, zásuvky). A hlavně se za 2€ dá jít na vyhlídkovou věž.</p></li>
<li><p><strong><a href="https://goo.gl/maps/ryRtvP1QioN2">Madrid Río</a></strong> - obrovský park podél řeky. Kromě jiného v něm mají i skluzavky a houpačky pro dospělé!</p></li>
<li><p><strong><a href="https://goo.gl/maps/gBEg4dXZs1G2">Matadero Madrid</a></strong> - původně jatka, udělali z toho kulturní centrum. Zajímavá architektura.</p></li>
<li><p><strong><a href="https://goo.gl/maps/JD3xQQ69PGy">Templo de Debod</a></strong> - starý egyptský chrám, je o něj pěkný výhled na západ slunce</p>

<p><img src="/data/2017/2017-11-25-madrid/debod.jpg" alt="Templo de Debod" /></p></li>
<li><p><strong><a href="https://goo.gl/maps/ww5V6MQRsc12">Rosaleda del Parque del Oeste</a></strong> - zahrada s růžemi</p></li>
<li><p><strong>Parque del Oeste</strong> - v jedné části parku je několik bunkrů z občanské války - <a href="https://mapy.cz/s/2dVrn">jsou vyznačené na Mapy.cz</a></p></li>
<li><p><strong><a href="https://goo.gl/maps/iNjmhcSewQT2">El Huerto de las Monjas (tras El Pasaje De Edificios)</a></strong> - schovaný minipark v centru města</p></li>
<li><p><strong><a href="https://goo.gl/maps/v2fCWwsUSrK2">Indalo Tapas Atocha</a></strong> - nevím jak vy, ale my máme problém si vybrat, do jaké hospody apod zajít. Tohle je jedna, kde jsme byli na tapas a bylo to fajn. Takže pokud budete okolo, tak tomu můžete dát šanci.</p></li>
<li><p><strong><a href="https://goo.gl/maps/4qV6FrA76212">La Panetteria</a></strong> - kavárna na náměstí Tirso de Molina. Byli jsme tam za ten týden dokonce 2×.</p></li>
</ul>

<h2 id="praktick%E3%A9">Praktické</h2>

<ul>
<li><p><strong>Metro</strong> - druhý nejlepší způsob dopravy po centru (nejlepší je chodit pěšky). Je potřeba si za 2€ koupit čipovou kartu a do ní potom třeba balíček deseti jízd. Můžete je klidně používat ve více lidech, prostě si u turniketu pípnete postupně oba. A pozor, na cestu z (a na) letiště si k běžné jízdence ještě musíte přikoupit Airport-pass za 3€. Na plánování trasy doporučuji používat Google Maps, fungují dobře.</p></li>
<li><p><strong>Pohledy a známky</strong> - pokud budete posílat pohledy, tak pozor, ať si koupíte správné známky. Správné jsou Correos, které koupíte třeba na poště. Ty se hází do žlutých poštovních schránek, kterých je docela dost. Ale v některých stáncích si můžete omylem koupit známky od něčeho, co se jmenuje "City Post". A ty musíte hodit do nějaké speciální červené schránky, která skoro nikde není. No a pokud si nevšimnete, že nemáte standardní známky a pohled hodíte do běžné poštovní schránky, tak nedorazí.</p></li>
<li><p><strong>Wi-fi</strong> - po městě je spoustu free wi-fi. Většina chce přihlášení přes Facebook, takže doporučuji si na to založit nějaký druhý účet (protože typicky to chce práva na sdílení příspěvků pod vámi).</p></li>
</ul>

<h2 id="outdoorvisit-outdoor-tours">OutdoorVisit outdoor tours</h2>

<p>Pokud chcete zkusit něco netradičního, tak doporučuji mrknout na <a href="https://www.outdoorvisit.com/madrid/?utm_source=martinhujer.cz&amp;utm_medium=web&amp;utm_campaign=blog_madrid_post">outdoorové zážitky a výlety v Madridu a okolí</a>.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[JavaScript Error Handler Bundle for Symfony]]></title>
            <link href="https://blog.martinhujer.cz/javascript-error-handler-bundle/"/>
            <updated>2017-11-04T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/javascript-error-handler-bundle/</id>
            <content type="html"><![CDATA[<p>I've created Symfony <a href="https://github.com/mhujer/JavaScriptErrorHandlerBundle">JavaScriptErrorHandlerBundle</a> for visualizing accidental errors in JavaScript.</p>

<h2 id="why%3F">Why?</h2>

<p>It is easy to break JavaScript code by an unrelated change. If you have JavaScript-only app, you will notice it immediately, because the app won't render at all (and your framework would report the error somehow).</p>

<p>On the other hand, if you are creating more traditional application with HTML rendered on the server and some interactions enhanced by jQuery, you may not notice that you've broken it. The browser reports the error into the Developer Console, but if you don't have it open, you are out of luck.</p>

<p>My <a href="https://github.com/mhujer/JavaScriptErrorHandlerBundle">JavaScriptErrorHandlerBundle</a> listens to <a href="https://developer.mozilla.org/en-US/docs/Web/API/GlobalEventHandlers/onerror"><code>window.onerror</code> events</a> and converts them to alerts, which are hard to miss.</p>

<p><img src="/data/2017/2017-11-04-javascript-error-handler-bundle/javascript-error-handler-bundle.png" alt="example alert with error" /></p>

<h2 id="how-does-it-work%3F">How does it work?</h2>

<p>The Bundle works automatically with zero configuration. You only have to install it through Composer and register in <code>AppKernel.php</code> (see <a href="https://github.com/mhujer/JavaScriptErrorHandlerBundle">README for instructions</a>).</p>

<p>It registers an event listener, which injects JavaScript snippet with error into the <code>&lt;head&gt;</code> section of the response (similarly to Symfony WebDebugToolbar). By default, the listener is registered only when the <code>%kernel.debug%</code> is set to <code>true</code>, so the error alert won't be ever displayed to your end users. The configuration cab be changed if necessary - e.g. you may want to have enabled also at the staging server.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I know that the bundle is very simple. I wanted to experiment with what it takes to create a proper Bundle, before I work on something more complicated. One of the challenging things was the automatic testing of the container extension (it contains the logic for registering the listener). Luckily, there is <a href="https://github.com/matthiasnoback/SymfonyDependencyInjectionTest">SymfonyDependencyInjectionTest</a> library created by Matthias Noback which makes container extension testing a breeze.</p>

<p>If you have time to dive into the bundle code, can you spot something that can I improve?</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[PHP 7.2 is due in November. What&#039;s new?]]></title>
            <link href="https://blog.martinhujer.cz/php-7-2-is-due-in-november-whats-new/"/>
            <updated>2017-09-07T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/php-7-2-is-due-in-november-whats-new/</id>
            <content type="html"><![CDATA[<blockquote>
  <p>I've published <a href="https://www.zdrojak.cz/clanky/jake-novinky-prinese-php-7-2/">the Czech translation of the article on Zdroják.cz</a>.</p>
</blockquote>

<p>PHP 7.2 is planned to be released on 30th November 2017 (see <a href="https://wiki.php.net/todo/php72#timetable">the timetable</a>). And it comes with two new security features in the core, several smaller improvements and some language legacy clean-ups. In the article, I will describe what the improvements and changes are. I read <a href="https://wiki.php.net/rfc#php_next_72">the RFCs</a>, discussions on <em>internals</em> and <a href="https://github.com/php/php-src/pulls">PRs on Github</a>, so you don't have to.</p>

<p><em>I'll update the article if there are any significant changes in PHP 7.2 until release.</em></p>

<p>You can try the pre-release version right now. Just download it using the links in the <a href="http://php.net/archive/2017.php#id2017-08-31-1">PHP 7.2.0 Release Candidate 1 Released</a>. I've been using it locally for development since the 7.2.0-beta1 without issues.</p>

<h2 id="rfc%3A-argon2-password-hash-link">RFC: Argon2 Password Hash (<a href="https://wiki.php.net/rfc/argon2_password_hash">link</a>)</h2>

<p><a href="http://php.net/password_hash"><code>password_hash</code></a> function has been available in PHP since 5.5. It was designed to be able to utilize different password hashing algorithms. But back then only <code>PASSWORD_BCRYPT</code> was available.</p>

<blockquote>
  <p><strong>IMPORTANT:</strong> If you are using <code>sha1()</code> or <code>md5()</code> for password hashing, please stop reading immediately and go fix your systems to use <code>password_hash()</code>. I recommend reading Michal's article <a href="https://www.michalspacek.com/upgrading-existing-password-hashes">Upgrading existing password hashes</a>.</p>
</blockquote>

<p>PHP 7.2 adds an option to use Argon2i algorithm with <code>PASSWORD_ARGON2I</code> constant:</p>

<pre><code class="php">password_hash('password', PASSWORD_ARGON2I)
</code></pre>

<p>Using <code>PASSWORD_BCRYPT</code> is still perfectly valid and safe option. Argon2i is just another option, which may become a default in the future.</p>

<p>Argon2i supports providing custom cost factors (like providing single <code>cost</code> factor to <code>bcrypt</code>):</p>

<pre><code class="php">$options = [
    'memory_cost' =&gt; PASSWORD_ARGON2_DEFAULT_MEMORY_COST,
    'time_cost' =&gt; PASSWORD_ARGON2_DEFAULT_TIME_COST,
    'threads' =&gt; PASSWORD_ARGON2_DEFAULT_THREADS,
];
password_hash('password', PASSWORD_ARGON2I, $options);
</code></pre>

<p>You should determine appropriate costs for Argon2i by experimenting on the target server (like you do with bcrypt <code>cost</code>).</p>

<p>It is also time to check your password column length! <code>PASSWORD_BCRYPT</code> generates 60 characters long hashes. <code>PASSWORD_ARGON2I</code> hash is 96 characters long. The <a href="http://php.net/password_hash"><code>password_hash</code> documentation</a> recommends columns length of 255 characters to accommodate any future hash (especially when using <code>PASSWORD_DEFAULT</code> as an algorithm):</p>

<blockquote>
  <p><em>It is recommended to store the result in a database column that can expand beyond 60 characters (255 characters would be a good choice).</em></p>
</blockquote>

<p>There is a good article about <a href="https://framework.zend.com/blog/2017-08-17-php72-argon2-hash-password.html">Protecting passwords with Argon2 in PHP 7.2</a> on Zend Framework blog.</p>

<p><strong>Note:</strong> Argon2i is available only if the PHP was compiled with <code>--with-password-argon2</code> flag. (It is included in Windows binaries available from php.net).</p>

<h2 id="rfc%3A-make-libsodium-a-core-extension-link">RFC: Make Libsodium a Core Extension (<a href="https://wiki.php.net/rfc/libsodium">link</a>)</h2>

<p>PHP 7.2 comes with cryptography library libsodium in the core. It was previously available through PECL. There is also a <a href="https://github.com/paragonie/sodium_compat">polyfill available</a> so you can start using it right now (it even supports PHP 5.2.4!).</p>

<p>I don't know much about the cryptography, but the single most important thing I know is this: <em>Don't invent your own cryptography!</em> (See <a href="https://security.stackexchange.com/a/18198">this StackExchange answer</a> for reasoning.).</p>

<p><strong>So just use the <code>sodium_</code> functions instead of implementing it by yourself.</strong></p>

<p>I recommend reading two following articles about upcoming improvements in PHP cryptography (both written by Scott Arciszewski, the author of the Libsodium RFC):</p>

<ol>
<li><p><a href="https://dev.to/paragonie/php-72-the-first-programming-language-to-add-modern-cryptography-to-its-standard-library">PHP 7.2: The First Programming Language to Add Modern Cryptography to its Standard Library</a></p>

<blockquote>
  <p><em>When version 7.2 releases at the end of the year, PHP will be the first programming language to adopt modern cryptography in its standard library.</em></p>
</blockquote></li>
<li><p><a href="https://paragonie.com/blog/2017/07/it-turns-out-2017-is-year-simply-secure-php-cryptography">It Turns Out, 2017 is the Year of Simply Secure PHP Cryptography</a> (by Scott Arciszewski as well).</p></li>
</ol>

<h2 id="other-interesting-changes">Other Interesting Changes</h2>

<h3 id="rfc%3A-object-typehint-link">RFC: Object typehint (<a href="https://wiki.php.net/rfc/object-typehint">link</a>)</h3>

<p>It will be possible to use <code>object</code> as parameter type and as a return type.</p>

<pre><code class="php">&lt;?php declare(strict_types = 1);

function foo(object $definitelyAnObject): object
{
    return 'another string';
}

foo('what about some string?');
// TypeError: Argument 1 passed to foo() must be an object, string given, called in...


foo(new \stdClass());
// TypeError: Return value of foo() must be an object, string returned

</code></pre>

<p><code>object</code> becomes a keyword in 7.2, so make sure you are not using it as a name for a class, interface or trait. It was a <a href="http://php.net/manual/en/reserved.other-reserved-words.php">soft-reserved word since PHP 7.0</a>.</p>

<p>It is useful mainly for libraries (ORMs, DI containers, serializers, <a href="https://externals.io/message/96554#96586">and others</a>). But it may help clean up some of your code as well. In our codebase, it will allow us to improve the helper method used in tests:</p>

<pre><code class="php">class TestUtils
{

    /**
     * @param object $object
     * @param string $propertyName
     * @param mixed $value
     */
    public static function setPrivateProperty($object, string $property, $value): void
    {
        if (!is_object($object)) {
            throw new \Exception('An object must be passed');
        }
</code></pre>

<p>Will be simplified to this:</p>

<pre><code class="php">class TestUtils
{
    public static function setPrivateProperty(object $object, string $property, $value): void
    {
</code></pre>

<h3 id="rfc%3A-parameter-type-widening-link">RFC: Parameter Type Widening (<a href="https://wiki.php.net/rfc/parameter-no-type-variance">link</a>)</h3>

<p>With this change, it is possible to omit the parameter type declaration in the child classes. I know that may sound confusing, so let's have a look at the example:</p>

<pre><code class="php">&lt;?php declare(strict_types = 1);

class LibraryClass 
{
    public function doWork(string $input)
    {

    }
}

class UserClass extends LibraryClass
{
    public function doWork($input)
    {

    }
}

// PHP &lt;7.2.0
// Warning: Declaration of UserClass::doWork($input) should be compatible with LibraryClass::doWork(string $input) in …

// PHP 7.2.0+
// no errors
</code></pre>

<p>It would allow libraries to introduce scalar typehints without breaking subclasses created by the library users. But it is rather theoretical possibility because the library cannot do the same for the return types. And when the library is adding parameter typehints, it makes sense to add return types as well.</p>

<p>Omitting type hints in subclasses follows the <a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle">Liskov substitution principle - LSP</a> because it widens the accepted types. But the subclass cannot omit return typehints, because that would widen the possible return types (and that is LSP violation).</p>

<p>This behaviour was also changed for abstract classes in separate RFC: <a href="https://wiki.php.net/rfc/allow-abstract-function-override">RFC: Allow abstract function override</a>.</p>

<h3 id="rfc%3A-counting-of-non-countable-objects-link">RFC: Counting of non-countable objects (<a href="https://wiki.php.net/rfc/counting_non_countables">link</a>)</h3>

<p>Did you know, that it is possible to count scalar values? Well, it does not really do much counting, it only returns 1 for scalars.</p>

<pre><code class="php">&lt;?php

var_dump(count(null)); // int(0)
var_dump(count(0)); // int(1)
var_dump(count(4)); // int(1)
var_dump(count('4')); // int(1)

</code></pre>

<p>Since PHP 7.2, it will begin emitting a warning:</p>

<pre><code>Warning: count(): Parameter must be an array or an object that implements Countable in /in/4aIl2 on line 3
</code></pre>

<p>I really like this change, because no one writes such code intentionally, but rather as a bug that needs fixing.</p>

<p>I guess that you may find some of those is your codebase as well - have a look at a less obvious example:</p>

<pre><code class="php">&lt;?php declare(strict_types = 1);

class Data
{
    /** @var string[] */
    private $data;

    public function addOne(string $item)
    {
        if (count($this-&gt;data) &gt;= 5) {
            throw new \Exception('too much data');
        }

        $this-&gt;data[] = $item;
    }
}

$data = new Data();
$data-&gt;addOne('item1');
$data-&gt;addOne('item2');
$data-&gt;addOne('item3');

// Warning: count(): Parameter must be an array or an object that implements Countable in ...
</code></pre>

<p>It will report a warning, because you are counting a <code>null</code> value in the <code>if</code>.</p>

<h3 id="rfc%3A-deprecations-for-php-7.2-link">RFC: Deprecations for PHP 7.2 (<a href="https://wiki.php.net/rfc/deprecations_php_7_2">link</a>)</h3>

<p>Can be also called <em>"Nikita Popov's language clean-up"</em> :-)</p>

<p>The following will throw a deprecation warning in PHP 7.2 and will be removed later (probably in 8.0). See <a href="https://wiki.php.net/rfc/deprecations_php_7_2">the RFC</a> for detailed explanation of each one:</p>

<ul>
<li><code>__autoload()</code> - use <a href="http://php.net/spl_autoload_register"><code>spl_autoload_register()</code></a> instead</li>
<li><code>$php_errormsg</code> - use <a href="http://php.net/error_get_last"><code>error_get_last()</code></a> instead</li>
<li><code>create_function()</code> - use closures instead</li>
<li><code>mbstring.func_overload</code> (ini setting) - use <code>mb_*</code> functions directly</li>
<li><code>(unset)</code> cast - this is not deprecating <code>unset($var)</code> but <code>$foo = (unset) $bar</code> which is equal to <code>$foo = null</code> (yes, strange one)</li>
<li><code>parse_str()</code> without second argument - directly creating variables when parsing query string is not something you should be doing (<code>register_globals</code> anyone?)</li>
<li><code>gmp_random()</code> - use <code>gmp_random_bits()</code> and <code>gmp_random_range()</code> instead</li>
<li><code>each()</code> - use <code>foreach</code> instead (it is more than 10 times faster)</li>
<li><code>assert()</code> with string argument - it is using <code>eval()</code> internally!</li>
<li><code>$errcontext</code> argument of error handler - use <code>debug_backtrace()</code> instead</li>
</ul>

<h2 id="smaller-changes">Smaller changes</h2>

<h3 id="rfc%3A-get_class-disallow-null-parameter-link">RFC: get_class() disallow null parameter (<a href="https://wiki.php.net/rfc/get_class_disallow_null_parameter">link</a>)</h3>

<p>Did you know, that <code>get_class()</code> without parameters returns the same value as <code>__CLASS__</code>? I didn't. But the RFC does not change this.</p>

<pre><code class="php">&lt;?php

class MyClass
{
    public function myInfo()
    {
        var_dump(get_class()); // string(7) "MyClass"
        var_dump(__CLASS__); // string(7) "MyClass"
    }
}

$a = new MyClass();
$a-&gt;myInfo();

var_dump(get_class($a)); // string(7) "MyClass"
</code></pre>

<p>The RFC deprecates calling it with <code>null</code> as parameter. Consider this example from the RFC. If the item is fetched from the repository and <code>$result</code> is not null, it will print the class name of the fetched object. But if it is null, <code>Foo</code> will be printed.</p>

<pre><code class="php">class Foo
{

    function bar($repository)
    {
        $result = $repository-&gt;find(100);

        echo get_class($result);
    }
}

// In 7.2: Warning: get_class() expects parameter 1 to be object, null given in ...
</code></pre>

<h3 id="rfc%3A-allow-loading-extensions-by-name-link">RFC: Allow loading extensions by name (<a href="https://wiki.php.net/rfc/load-ext-by-name">link</a>)</h3>

<p>If you configured the PHP extensions before 7.2, you had to use full filename in the <code>.ini</code> file:</p>

<p>On Windows:</p>

<pre><code class="ini">extension=php_mbstring.dll
</code></pre>

<p>On Linux:</p>

<pre><code class="ini">extension=mbstring.so
</code></pre>

<p>That's fine if you are using only one platform. But it gets a bit harder, if you need to write some automation scripts supporting multiple platforms. It was improved in 7.2 and now you can use this both on Linux and Windows:</p>

<pre><code class="ini">extension=mbstring
</code></pre>

<p>Legacy syntax is still supported, but it is recommended to use the new one.</p>

<h3 id="rfc%3A-deprecate-and-remove-bareword-unquoted-strings-link">RFC: Deprecate and Remove Bareword (Unquoted) Strings (<a href="https://wiki.php.net/rfc/deprecate-bareword-strings">link</a>)</h3>

<p>This is another step in making PHP safer to use. If you mistype a constant in 7.2, it will throw a warning instead of notice (and will throw an error in PHP 8.0).</p>

<p>Simplest example is this:</p>

<pre><code class="php">&lt;?php
var_dump(NONEXISTENT_CONSTANT);


// PHP 7.1
// Notice: Use of undefined constant NONEXISTENT_CONSTANT - assumed 'NONEXISTENT_CONSTANT' in …

// PHP 7.2
// Warning: Use of undefined constant NONEXISTENT_CONSTANT - assumed 'NONEXISTENT_CONSTANT' (this will throw an Error in a future version of PHP) in …
</code></pre>

<p>I really like the bug examples <a href="https://wiki.php.net/rfc/deprecate-bareword-strings">in the RFC</a> showing what it's aiming to prevent:</p>

<pre><code class="php">$foo = flase; // typo!
// ...
if ( $foo ) {
   var_dump($foo); // string(5) "flase"
}
</code></pre>

<p>And:</p>

<pre><code class="php">$found = false;
foreach ( $list as $item ) {
   if ( is_null($item) ) {
       contniue; // this statement issues a notice and does nothing
   }
   // lines assuming $item is not null
}
</code></pre>

<h3 id="rfc%3A-trailing-commas-in-list-syntax-link">RFC: Trailing Commas in List Syntax (<a href="https://wiki.php.net/rfc/list-syntax-trailing-commas">link</a>)</h3>

<p>It has <a href="https://3v4l.org/J8r9B">always been possible</a> to use trailing comma after last array item:</p>

<pre><code class="php">$foo = [
    'foo',
    'bar',
];
</code></pre>

<p>It is useful for creating clean diffs in VCS and makes adding new items to the list simple.</p>

<p>This RFC proposed adding an optional trailing comma to all list-like places:</p>

<ul>
<li>Grouped namespaces</li>
<li>Function/method arguments (declarations &amp; calls)</li>
<li>Interface implementations on a class</li>
<li>Trait implementations on a class</li>
<li>Class member lists</li>
<li>Inheriting variables from the parent scope in anonymous functions</li>
</ul>

<p>I especially hoped for method arguments declarations and calls. But it did not pass the vote (which needed 2/3 majority, as it is a language change).</p>

<p>Surprisingly, only the <em>"Grouped namespaces"</em> passed:</p>

<pre><code class="php">use Foo\Bar\{ 
    Foo,
    Bar, 
    Baz, 
}; 

// note the comma after "Baz"
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>PHP 7.2 will contain new security features (sodium, Argon2i), several language improvements (<code>object</code> typehint, type widening) and a variety of minor changes that polish legacy parts of the language.</p>

<p>The <a href="http://php.net/archive/2017.php#id2017-08-31-1">RC1</a> was released on 31st August, so it is now a right time to try it out. If you can't or don't want to use it locally for development just yet, you should at least run your test suite against PHP 7.2 to see if there is anything to be fixed. I think there won't be many compatibility issues in a well-managed codebase.</p>

<p>If you are maintaining an open-source project, you should add 7.2 to TravisCI build matrix to ensure that your users won't encounter any compatibility issues. Or you can require PHP 7.2 in the next major version <a href="https://github.com/doctrine/doctrine2/pull/6577">like Doctrine ORM will</a>.</p>

<p>Thank you, Sara and Remi, and all the contributors for making this PHP release great!</p>

<p>What are you looking forward to most in the PHP 7.2?</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Don&#039;t Use Entities in Symfony Forms. Use Custom Data Objects Instead]]></title>
            <link href="https://blog.martinhujer.cz/symfony-forms-with-request-objects/"/>
            <updated>2017-08-23T00:00:00+00:00</updated>
            <id>https://blog.martinhujer.cz/symfony-forms-with-request-objects/</id>
            <content type="html"><![CDATA[<blockquote>
  <p>First part of this article explains why entities should not be used directly in Symfony Forms. Second part presents an approach which solves most of the problems presented in the first part.</p>
</blockquote>

<p>Let's start with stating that <strong>using entities for validation in Symfony Forms</strong> is widely used and widely recommend approach. Even the <a href="https://symfony.com/doc/current/forms.html">official documentation</a> suggests it.</p>

<p><strong>And I don't think it is a good idea!</strong></p>

<p><strong>Why?</strong></p>

<h3 id="1.-an-entity-should-be-always-valid.">1. An entity should be always valid.</h3>

<p>An entity should be always valid. It should not be possible for the entity to get to some inconsistent state. And that's exactly what the form validation is doing. When the form is submitted, the data are injected (through public properties or setters) into the entity and validated. And even if the validation fails, the invalid data are kept there and you have an invalid entity at hand.</p>

<blockquote>
  <p>Read <a href="https://ocramius.github.io/doctrine-best-practices/">those slides</a> from Ocramius or <a href="https://vimeo.com/134178140">watch the video</a> for great explanation what is means to have a valid entity (and much more).</p>
</blockquote>

<p>It's also not that hard to imagine the situation when this can cause you serious trouble. If the entity is already managed by EntityManager (because it is an <code>updateAction</code>) and there is a <code>$entityManager-&gt;flush()</code> call lurking in some listener, you'd end up with invalid data stored in database.</p>

<h3 id="2.-change%21-change%21-change%21">2. Change! Change! Change!</h3>

<p>The only sure thing about the software development is "change". Eventually you will need to change the structure of the form, maybe split it in two-step form. And the form fields will no longer map exactly 1:1 to entity's fields.</p>

<h3 id="3.-layers-separation">3. Layers separation</h3>

<p>It breaks the layers separation. Each layer should depend only on the deeper ones, not the other way around.</p>

<hr />

<p>What can we do instead of using entities in forms? Symfony documentation describes <a href="https://symfony.com/doc/current/form/without_class.html">how to use forms with data stored in array</a>. It is a viable solution, but it has disadvantages as well. Some I can think of is that you won't get code completion in IDE for the form data. Or that it is hard to statically analyze arrays with tools such as <a href="https://github.com/phpstan/phpstan">PHPStan</a>.</p>

<p>And there is another solution, the one I prefer.</p>

<h2 id="custom-data-classes-for-the-win">Custom Data Classes for the win</h2>

<p>To get around the disadvantages mentioned above, I suggest using a custom class to represent the form data.</p>

<p>Let's have a look at the example:</p>

<pre><code class="php">use Symfony\Component\Validator\Constraints as Assert;

class CreateArticleRequest
{

    /**
     * @Assert\NotBlank()
     * @Assert\Length(min="10", max="100")
     * @var string
     */
    public $title;

    /**
     * @Assert\NotBlank()
     * @var string
     */
    public $content;

    /**
     * @Assert\DateTime()
     * @var \DateTimeImmutable
     */
    public $publishDate;

}
</code></pre>

<p>It is a simple class that has some public properties and validator annotations. The main advantage is that is has nothing to do with the actual entity. <code>CreateArticleRequest</code> can handle as much of invalid data as you want and it won't cause you any trouble.</p>

<p>Second step is using the request object in the controller. You can use it the same way you'd use the entity (the following code should be self-explanatory):</p>

<pre><code class="php">  /**
     * @Route("/article/create/", name="article_create")
     */
    public function createAction(Request $request)
    {
        // create an instance of an empty CreateArticleRequest
        $createArticleRequest = new CreateArticleRequest();

        // create a form but with a request object instead of entity
        $form = $this-&gt;createForm(ArticleFormType::class, $createArticleRequest);
        $form-&gt;handleRequest($request);

        if ($form-&gt;isSubmitted() &amp;&amp; $form-&gt;isValid()) {

            // ArticleFacade creates instance of an Article,
            // persists it and flushes the EntityManager.
            // (details are out of scope of this article)

            $article = $this-&gt;articleFacade-&gt;createArticle(
                $createArticleRequest-&gt;title,
                $createArticleRequest-&gt;content,
                $createArticleRequest-&gt;publishDate
            );

            // ... use $article to add title to flash message or something

            return $this-&gt;redirectToRoute('articles_list');
        }

        // render the form if it is the first request or if the validation failed
        return $this-&gt;render('article/add-article.html.twig', [
            'form' =&gt; $form-&gt;createView(),
        ]);
    }
</code></pre>

<p>And for the sake of completeness, the source of <code>ArticleFormType</code>:</p>

<pre><code class="php">class ArticleFormType extends \Symfony\Component\Form\AbstractType
{

    public function buildForm(FormBuilderInterface $builder, array $options): void
    {
        $builder
            -&gt;add('title', TextType::class, [
                'label' =&gt; 'Article title',
            ])
            -&gt;add('content', TextareaType::class, [
                'label' =&gt; 'Article title',
            ])
            -&gt;add('publishDate', DateTimeType::class, [
                'label' =&gt; 'Publish on',
            ])
            -&gt;add('save', SubmitType::class, [
                'label' =&gt; 'Save',
            ]);
    }
}
</code></pre>

<p>I call the data class <code>CreateArticleRequest</code> because it is a <em><code>Request</code></em> to create an article. You will probably also have a <code>UpdateArticleRequest</code> class with different properties (in some cases, both classes may be the same, so one <code>ArticleRequest</code> would be sufficient).</p>

<p>The <code>*Request</code> suffix may cause some confusion with the <code>Request</code> class which represents a HTTP request. If that is your case, you are free to change the suffix to <code>*Data</code> and use a class called <code>CreateArticleData</code>.</p>

<h2 id="what-about-update-form%3F">What about update form?</h2>

<p>One of the specifics of the update is that it won't necessarily have the exact same fields as the "create". In the example, we don't want to update the <code>publishDate</code> field in the entity. The <code>UpdateArticleRequest</code> will look like this:</p>

<pre><code class="php">use Symfony\Component\Validator\Constraints as Assert;

class UpdateArticleRequest
{

    /**
     * @Assert\NotBlank()
     * @Assert\Length(min="10", max="100")
     * @var string
     */
    public $title;

    /**
     * @Assert\NotBlank()
     * @var string
     */
    public $content;

    public static function fromArticle(Article $article): self
    {
        $articleRequest = new self();
        $articleRequest-&gt;title = $article-&gt;getTitle();
        $articleRequest-&gt;content = $article-&gt;getContent();

        return $articleRequest;
    }
}
</code></pre>

<p>You can see that the <code>$publishDate</code> field is missing, but more importantly, we have a new method there - <code>fromArticle(Article $article)</code>. It allows you to prepopulate the data from the existing article.</p>

<p>Check the following example of <code>updateAction()</code> to see how to use it in controller:</p>

<pre><code class="php">    /**
     * @Route("/article/update/{id}/", name="article_update")
     */
    public function updateAction(Article $article, Request $request)
    {
        // the $article argument is converted from {id} by implicit ParamConverter

        // pre-populate the UpdateArticleRequest instance with the data from the article
        $updateArticleRequest = UpdateArticleRequest::fromArticle($article);

        $form = $this-&gt;createForm(UpdateArticleFormType::class, $updateArticleRequest);
        $form-&gt;handleRequest($request);

        if ($form-&gt;isSubmitted() &amp;&amp; $form-&gt;isValid()) {

            // ArticleFacade updates instance of an Article and flushes the EntityManager.
            // (details are out of scope of this article)

            $this-&gt;articleFacade-&gt;updateArticle(
                $article,
                $updateArticleRequest-&gt;title,
                $updateArticleRequest-&gt;content
            );

            // ... use $article to add title to flash message or something

            return $this-&gt;redirectToRoute('articles_list');
        }

        return $this-&gt;render('article/edit-article.html.twig', [
            'form' =&gt; $form-&gt;createView(),
        ]);
    }
</code></pre>

<p>You may think - that's a lot of code to write! I agree, but rest assured it is worth it in the long run. If your app contains some business logic and is not just a plain CRUD, it will eventually need different fields and validation rules during <em>create</em> and <em>update</em>. Then you will make good use of this extra code you had written.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In the article, I suggested why it may not be the best idea to use entities in Symfony Forms. The second part of the article proposes a way how to tackle this problem - by using a custom object instead of entity to carry the data and handle the validation.</p>

<p>There are two more takeaways:</p>

<ol>
<li>Always separate the application layers.</li>
<li>Do not blindly follow the documentation (or other developers).</li>
</ol>

<p><strong>Do you use similar solution in your projects? If you are using entities, have you already encountered any problems?</strong></p>

<p>Finally, you may want to read two related articles: <a href="https://stovepipe.systems/post/avoiding-entities-in-forms">Avoiding Entities in Forms</a> and <a href="https://stovepipe.systems/post/rethinking-form-development">Rethinking Form Development</a> (written by Iltar van der Berg).</p>
]]></content>
        </entry>
    </feed>